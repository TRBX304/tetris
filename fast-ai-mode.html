
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Å™„ÉÜ„Éà„É™„Çπ„Ç≤„Éº„É†„ÄÅÁÑ°Êñô„ÅßÈÅä„Åπ„Çã„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Å™„Éñ„É©„Ç¶„Ç∂Áâà„ÉÜ„Éà„É™„Çπ„ÄÇ„Çπ„Éû„Éõ„ÉªPCÂØæÂøú„ÄÅAIË¶≥Êà¶„É¢„Éº„ÉâÊê≠Ëºâ„ÄÇ„Ç§„É≥„Çπ„Éà„Éº„É´‰∏çË¶Å„Åß„Åô„ÅêÈÅä„Åπ„Çã„ÄÅ„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†ÂèØËÉΩ„Å™PWAÂØæÂøú">
    <meta name="robots" content="index, follow">
    <!-- OGP -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="TETRIS-LIKE | ÁÑ°Êñô„Éñ„É©„Ç¶„Ç∂Áâà„ÉÜ„Éà„É™„ÇπÈ¢®„Ç≤„Éº„É†">
    <meta property="og:description" content="„Çπ„Éû„Éõ„ÉªPCÂØæÂøú„ÄÅAIË¶≥Êà¶„É¢„Éº„ÉâÊê≠Ëºâ„ÄÇ„Ç§„É≥„Çπ„Éà„Éº„É´‰∏çË¶Å„Åß„Åô„ÅêÈÅä„Åπ„ÇãËêΩ„Å°„ÇÇ„ÅÆ„Éë„Ç∫„É´">
    <meta property="og:image" content="https://tetris-like.pages.dev/ogp.png">
    <meta property="og:url" content="https://tetris-like.pages.dev/">
    <meta property="og:site_name" content="TETRIS-LIKE">
    <meta property="og:locale" content="ja_JP">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TETRIS-LIKE | ÁÑ°Êñô„Éñ„É©„Ç¶„Ç∂Áâà„ÉÜ„Éà„É™„ÇπÈ¢®„Ç≤„Éº„É†">
    <meta name="twitter:description" content="„Çπ„Éû„Éõ„ÉªPCÂØæÂøú„ÄÅAIË¶≥Êà¶„É¢„Éº„ÉâÊê≠Ëºâ„ÄÇ„Ç§„É≥„Çπ„Éà„Éº„É´‰∏çË¶Å„Åß„Åô„ÅêÈÅä„Åπ„Çã">
    <meta name="twitter:image" content="https://tetris-like.pages.dev/ogp.png">
    <link rel="icon" href="/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0b45464586344910a274a959d7a31fde"}'></script><!-- End Cloudflare Web Analytics -->
    <title>TETRIS-LIKE | ÁÑ°Êñô„ÅßÈÅä„Åπ„Çã„Éñ„É©„Ç¶„Ç∂Áâà„ÉÜ„Éà„É™„ÇπÈ¢®„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iOS „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
        html {
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 90% 60%, rgba(255, 255, 255, 0.15), transparent),
                radial-gradient(1px 1px at 33% 85%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 75% 40%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 15% 65%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 45% 15%, rgba(255, 255, 255, 0.25), transparent),
                radial-gradient(1px 1px at 95% 85%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 25% 45%, rgba(255, 255, 255, 0.15), transparent),
                radial-gradient(2px 2px at 70% 90%, rgba(255, 255, 255, 0.25), transparent);
            background-size: 200% 200%;
            background-position: 0% 0%;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
            position: relative;
        }

        /* ÊòüÂ∫ßÈ¢®ËÉåÊôØ */
        .stars-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0.6;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .constellation-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, 
                rgba(100, 200, 255, 0) 0%, 
                rgba(100, 200, 255, 0.3) 50%, 
                rgba(100, 200, 255, 0) 100%);
            transform-origin: left center;
        }

        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5);
            animation: shoot 3s linear infinite;
            opacity: 0;
        }

        @keyframes shoot {
            0% {
                opacity: 0;
                transform: translateX(0) translateY(0);
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: translateX(300px) translateY(300px);
            }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 40px;
            color: #00ffff;
            text-align: center;
            letter-spacing: 8px;
        }

        .action-display {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-text {
            font-size: 20px;
            font-weight: bold;
            color: #ffff00;
            background-color: rgba(128, 0, 128, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .game-area {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        #gameCanvas {
            border: 3px solid #475569;
            background-color: #1e293b;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 200px;
        }

        .panel-section {
            background-color: rgba(30, 41, 59, 0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .panel-section h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            text-align: center;
        }

        #nextCanvas {
            display: block;
            margin: 0 auto;
            background-color: rgba(128, 128, 128, 0.2);
            border-radius: 8px;
        }

        .score-display {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }

        .level-value {
            color: #ffff00;
        }

        .controls-info {
            font-size: 10px;
            line-height: 1.6;
            color: #ccc;
        }

        .controls-info h4 {
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            text-align: center;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .button-group button {
            flex: 1;
        }

        /* Êìç‰ΩúÂàá„ÇäÊõø„Åà„Éà„Ç∞„É´ */
        #controlTogglePanel {
            padding: 10px;
        }

        #controlTogglePanel h3 {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00ffff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-text {
            font-size: 12px;
            color: #aaa;
        }

        /* „Çπ„ÉØ„Ç§„ÉóÊìç‰ΩúË™¨Êòé */
        .swipe-instructions {
            margin-top: 10px;
            padding: 8px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 6px;
            font-size: 10px;
            color: #888;
            line-height: 1.6;
        }

        .swipe-instructions.hidden {
            display: none;
        }

        .swipe-title {
            color: #aaa;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 11px;
        }

        /* „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ */
        .button-controls {
            position: fixed;
            bottom: 20px;
            right: 30px;
            display: flex;
            justify-content: flex-end;
            z-index: 100;
            pointer-events: none;
        }

        .dpad-container {
            pointer-events: auto;
        }

        /* ÂçÅÂ≠ó„Ç≠„Éº */
        .dpad {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .dpad-row {
            display: flex;
            gap: 0;
        }

        .dpad-btn {
            width: 50px;
            height: 50px;
            background: rgba(58, 58, 58, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            color: rgba(255, 255, 255, 0.95);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .dpad-btn:active {
            background: rgba(80, 80, 80, 0.6);
            transform: scale(0.95);
        }

        .dpad-empty {
            width: 50px;
            height: 50px;
        }

        .dpad-center {
            width: 50px;
            height: 50px;
            background: rgba(26, 26, 26, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            border-radius: 50%;
        }

        .dpad-center-btn {
            width: 50px;
            height: 50px;
            background: rgba(26, 26, 26, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.95);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .dpad-center-btn:active {
            background: rgba(80, 80, 80, 0.6);
            transform: scale(0.95);
        }

        /* „Éç„Ç™„É≥ÂäπÊûú */
        .neon-glow {
            box-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 20px currentColor,
                inset 0 0 5px rgba(255, 255, 255, 0.2);
        }

        /* „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes lineFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes lineClear {
            0% { 
                transform: scaleX(1);
                opacity: 1;
            }
            50% {
                transform: scaleX(1.1);
                opacity: 0.5;
            }
            100% { 
                transform: scaleX(0);
                opacity: 0;
            }
        }

        button {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .pause-button {
            background-color: #ffff00;
            color: #000;
        }

        .reset-button {
            background-color: #00ffff;
            color: #000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-content {
            background-color: #1e293b;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid;
        }

        .game-over-overlay {
            border-color: #ff0000;
        }

        .pause-overlay {
            border-color: #ffff00;
        }

        .overlay-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .game-over-title {
            color: #ff0000;
        }

        .pause-title {
            color: #ffff00;
        }

        .overlay-score {
            font-size: 20px;
            color: #fff;
            margin-bottom: 20px;
        }

        .overlay-button {
            background-color: #00ffff;
            color: #000;
            font-size: 18px;
            padding: 15px 30px;
        }

        .hidden {
            display: none;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .home-screen {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .home-title {
            font-size: 60px;
            color: #00ffff;
            letter-spacing: 12px;
            margin-bottom: 40px;
            text-shadow: 0 0 20px #00ffff;
        }

        /* „Çø„Ç§„Éà„É´„Ç≥„É≥„ÉÜ„Éä„Å®info„Éú„Çø„É≥ */
        .home-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
        }

        .home-title-container .home-title {
            margin-bottom: 0;
        }

        .info-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .info-button:hover {
            background: #00ffff;
            color: #000;
            transform: scale(1.1);
        }

        /* Info„É¢„Éº„ÉÄ„É´ */
        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .info-modal.hidden {
            display: none;
        }

        .info-modal-content {
            background-color: #1e293b;
            padding: 30px;
            border-radius: 12px;
            border: 3px solid #00ffff;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .info-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #888;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .info-modal-close:hover {
            background: #ff4444;
            border-color: #ff4444;
            color: #fff;
        }

        .info-modal-title {
            font-size: 28px;
            color: #00ffff;
            text-align: center;
            margin-bottom: 25px;
            padding-right: 30px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            font-size: 18px;
            color: #ffff00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-section p, .info-section ul {
            color: #ccc;
            font-size: 14px;
            line-height: 1.8;
        }

        .info-section ul {
            list-style: none;
            padding-left: 0;
        }

        .info-section li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .info-section li::before {
            content: "‚Ä¢";
            color: #00ffff;
            position: absolute;
            left: 0;
        }

        .info-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-controls-col h4 {
            color: #00ffff;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .info-controls-col ul {
            font-size: 13px;
        }

        .info-divider {
            border: none;
            border-top: 1px solid rgba(71, 85, 105, 0.5);
            margin: 20px 0;
        }

        .info-contact {
            text-align: center;
            color: #888;
            font-size: 13px;
        }

        .info-contact a {
            color: #00ffff;
            text-decoration: none;
        }

        .info-contact a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .home-title-container {
                flex-direction: row;
                gap: 10px;
                margin-bottom: 30px;
            }

            .info-button {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }

            .info-modal-content {
                padding: 20px;
                max-height: 85vh;
            }

            .info-modal-title {
                font-size: 22px;
            }

            .info-section h3 {
                font-size: 16px;
            }

            .info-controls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        .mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .mode-button {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ffff;
            padding: 30px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-button:hover {
            transform: translateY(-5px);
            border-color: #ffff00;
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3);
        }

        .mode-button h2 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .mode-button p {
            color: #aaa;
            font-size: 14px;
            margin: 5px 0;
        }

        .mode-button .best-time {
            color: #ffff00;
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* AIË¶≥Êà¶„É¢„Éº„Éâ„Éà„Ç∞„É´ */
        .ai-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #ff00ff;
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .ai-toggle-label {
            position: relative;
            width: 60px;
            height: 32px;
            cursor: pointer;
        }

        .ai-toggle-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ai-toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            border-radius: 32px;
            transition: 0.3s;
        }

        .ai-toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .ai-toggle-label input:checked + .ai-toggle-slider {
            background: linear-gradient(135deg, #ff00ff, #8800ff);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }

        .ai-toggle-label input:checked + .ai-toggle-slider:before {
            transform: translateX(28px);
        }

        .ai-toggle-text {
            color: #ff00ff;
            font-size: 20px;
            font-weight: bold;
        }

        .ai-toggle-desc {
            color: #888;
            font-size: 14px;
            width: 100%;
            text-align: center;
        }

        .ai-toggle-desc.active {
            color: #ff00ff;
        }

        .rankings {
            background: rgba(30, 41, 59, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .rankings h3 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ranking-tab {
            background: rgba(128, 128, 128, 0.3);
            color: #aaa;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .ranking-tab.active {
            background: #00ffff;
            color: #000;
            border-color: #00ffff;
        }

        .ranking-subtabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .ranking-subtab {
            background: rgba(128, 128, 128, 0.2);
            color: #888;
            border: 1px solid #444;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .ranking-subtab.active {
            background: linear-gradient(135deg, #ff00ff, #8800ff);
            color: #fff;
            border-color: #ff00ff;
        }

        .ranking-subtab:first-child.active {
            background: linear-gradient(135deg, #00aaff, #0066ff);
            border-color: #00aaff;
        }

        .ranking-list {
            text-align: left;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            border-left: 3px solid #00ffff;
        }

        .ranking-item .rank {
            color: #ffff00;
            font-weight: bold;
            min-width: 40px;
        }

        .ranking-item .time {
            color: #00ffff;
            font-weight: bold;
        }

        .ranking-item .date {
            color: #888;
            font-size: 12px;
        }

        /* „Çø„Ç§„É†Ë°®Á§∫ */
        .time-display {
            font-size: 18px;
            color: #ffff00;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .mode-info {
            font-size: 14px;
            color: #00ffff;
            text-align: center;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .home-title {
                font-size: 40px;
                letter-spacing: 8px;
                margin-bottom: 30px;
            }

            .mode-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .mode-button {
                padding: 20px 15px;
            }

            .mode-button h2 {
                font-size: 20px;
            }

            .ranking-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .ranking-tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }

            .game-container {
                gap: 10px;
                width: 100%;
                max-height: 100vh;
                padding-bottom: 180px; /* „Éú„Çø„É≥Êìç‰Ωú„Çπ„Éö„Éº„ÇπÁ¢∫‰øù */
            }

            h1 {
                font-size: 24px;
                letter-spacing: 4px;
                margin-top: 5px;
            }

            .action-display {
                min-height: 30px;
            }

            .action-text {
                font-size: 14px;
                padding: 6px 12px;
            }

            .game-area {
                flex-direction: row;
                align-items: flex-start;
                width: 100%;
                gap: 8px;
                justify-content: center;
            }

            #gameCanvas {
                flex-shrink: 0;
            }

            .side-panel {
                width: auto;
                min-width: 100px;
                gap: 8px;
                flex-shrink: 1;
            }

            .panel-section {
                padding: 8px;
            }

            .panel-section h3 {
                font-size: 10px;
                margin-bottom: 4px;
            }

            #nextCanvas {
                width: 80px;
                height: 80px;
            }

            .score-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .score-value {
                font-size: 16px;
            }

            .button-group {
                gap: 6px;
            }

            button {
                font-size: 11px;
                padding: 8px 6px;
            }

            .overlay-content {
                padding: 20px;
                margin: 10px;
            }

            .overlay-title {
                font-size: 28px;
            }

            .overlay-score {
                font-size: 16px;
            }

            .overlay-button {
                font-size: 16px;
                padding: 12px 24px;
            }

            .dpad-btn {
                width: 70px;
                height: 70px;
                font-size: 20px;
            }

            .dpad-empty, .dpad-center, .dpad-center-btn {
                width: 70px;
                height: 70px;
            }

            .button-controls {
                right: 20px;
                bottom: 15px;
            }

            #controlTogglePanel {
                padding: 6px;
            }

            #controlTogglePanel h3 {
                font-size: 10px;
            }

            .toggle-text {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                letter-spacing: 2px;
            }

            .game-area {
                gap: 6px;
            }

            .side-panel {
                min-width: 90px;
                gap: 6px;
            }

            .panel-section {
                padding: 6px;
            }

            #nextCanvas {
                width: 70px;
                height: 70px;
            }

            .score-value {
                font-size: 14px;
            }

            button {
                font-size: 10px;
                padding: 6px 4px;
            }
        }

        @media (min-width: 769px) {
            .side-panel {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- ÊòüÂ∫ßÈ¢®ËÉåÊôØ -->
    <div class="stars-background" id="starsBackground"></div>
    
    <section style="display:none;">
      <h2>„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åß„Åç„Çã„ÉÜ„Éà„É™„ÇπÈ¢®„Ç≤„Éº„É†</h2>
      <p>
        „Åì„ÅÆ„ÉÜ„Éà„É™„ÇπÈ¢®„Ç≤„Éº„É†„ÅØPWAÂØæÂøú„ÅÆ„Éñ„É©„Ç¶„Ç∂„Ç≤„Éº„É†„Åß„Åô„ÄÇ
        „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„Åß„ÅØ„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Åô„Çã„Åì„Å®„Åß„ÄÅ
        „Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´„ÉØ„É≥„Çø„ÉÉ„Éó„ÅßËµ∑Âãï„Åß„Åç„Åæ„Åô„ÄÇ
        „Ç§„É≥„Çπ„Éà„Éº„É´‰∏çË¶Å„Åß„ÄÅ„Ç™„Éï„É©„Ç§„É≥„Åß„ÇÇÈÅä„Åπ„ÇãË®≠Ë®à„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ
      </p>
    </section>
    
    <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
    <div id="homeScreen" class="home-screen">
        <div class="home-title-container">
            <h1 class="home-title">TETRIS-LIKE</h1>
            <button class="info-button" onclick="toggleInfoModal()">‚ìò</button>
        </div>

        
        <!-- AIË¶≥Êà¶„É¢„Éº„Éâ„Éà„Ç∞„É´ -->
        <div class="ai-toggle-container">
            <label class="ai-toggle-label">
                <input type="checkbox" id="aiModeToggle" onchange="toggleAIMode()">
                <span class="ai-toggle-slider"></span>
            </label>
            <span class="ai-toggle-text">ü§ñ AIË¶≥Êà¶„É¢„Éº„Éâ</span>
            <span class="ai-toggle-desc" id="aiModeDesc">OFF - Ëá™ÂàÜ„Åß„Éó„É¨„Ç§</span>
        </div>
        
        <div class="mode-selection">
            <div class="mode-button" onclick="startGame('normal')">
                <h2>„Éé„Éº„Éû„É´</h2>
                <p>„Ç®„É≥„Éâ„É¨„Çπ„É¢„Éº„Éâ</p>
                <p>„Çπ„Ç≥„Ç¢„Ç¢„Çø„ÉÉ„ÇØ</p>
                <div class="best-time" id="normalBest">ÊúÄÈ´ò: - ÁÇπ</div>
            </div>
            
            <div class="mode-button" onclick="startGame('sprint1m')">
                <h2>1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà</h2>
                <p>60Áßí„ÉÅ„É£„É¨„É≥„Ç∏</p>
                <p>„É©„Ç§„É≥Êï∞„ÇíÁ´∂„ÅÜ</p>
                <div class="best-time" id="sprint1mBest">ÊúÄÈ´ò: - „É©„Ç§„É≥</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time10')">
                <h2>10„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>10„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time10Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time20')">
                <h2>20„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>20„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time20Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time40')">
                <h2>40„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>40„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time40Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time100')">
                <h2>100„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>100„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time100Best">Ë®òÈå≤: --:--.---</div>
            </div>
        </div>

        <div class="rankings">
            <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
            <div class="ranking-tabs">
                <button class="ranking-tab active" onclick="showRanking('normal', event)">„Éé„Éº„Éû„É´</button>
                <button class="ranking-tab" onclick="showRanking('sprint1m', event)">1ÂàÜÈñì</button>
                <button class="ranking-tab" onclick="showRanking('time10', event)">10„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time20', event)">20„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time40', event)">40„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time100', event)">100„É©„Ç§„É≥</button>
            </div>
            <div class="ranking-subtabs">
                <button class="ranking-subtab active" onclick="toggleRankingType('human', event)">üë§ ‰∫∫Èñì</button>
                <button class="ranking-subtab" onclick="toggleRankingType('ai', event)">ü§ñ AI</button>
            </div>
            <div class="ranking-list" id="rankingList"></div>
        </div>
    </div>

    <!-- Info„É¢„Éº„ÉÄ„É´ -->
    <div id="infoModal" class="info-modal hidden">
        <div class="info-modal-content">
            <button class="info-modal-close" onclick="toggleInfoModal()">‚úï</button>
            <h2 class="info-modal-title">üìñ Information</h2>

            <div class="info-section">
                <h3>üéÆ „Ç≤„Éº„É†„É¢„Éº„Éâ</h3>
                <ul>
                    <li><strong>„Éé„Éº„Éû„É´</strong>: „Ç®„É≥„Éâ„É¨„Çπ„É¢„Éº„Éâ„ÄÇ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Åæ„Åß„Çπ„Ç≥„Ç¢„ÇíÁ®º„Åî„ÅÜ</li>
                    <li><strong>1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà</strong>: 60ÁßíÈñì„Åß„Åß„Åç„Çã„Å†„ÅëÂ§ö„Åè„ÅÆ„É©„Ç§„É≥„ÇíÊ∂à„Åù„ÅÜ</li>
                    <li><strong>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</strong>: ÁõÆÊ®ô„É©„Ç§„É≥Êï∞„Çí„Å©„Çå„Å†„ÅëÊó©„ÅèÊ∂à„Åõ„Çã„ÅãÁ´∂„Åä„ÅÜÔºà10/20/40/100„É©„Ç§„É≥Ôºâ</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>üïπÔ∏è Êìç‰ΩúÊñπÊ≥ï</h3>
                <div class="info-controls-grid">
                    <div class="info-controls-col">
                        <h4>üíª PCÔºà„Ç≠„Éº„Éú„Éº„ÉâÔºâ</h4>
                        <ul>
                            <li>‚Üê ‚Üí : Â∑¶Âè≥ÁßªÂãï</li>
                            <li>‚Üë : ÂõûËª¢</li>
                            <li>‚Üì : È´òÈÄüËêΩ‰∏ã</li>
                            <li>Space : ‰∏ÄÊ∞ó„Å´ËêΩ‰∏ã</li>
                            <li>P : ‰∏ÄÊôÇÂÅúÊ≠¢</li>
                        </ul>
                    </div>
                    <div class="info-controls-col">
                        <h4>üì± „Çπ„Éû„ÉõÔºà„Çπ„ÉØ„Ç§„ÉóÔºâ</h4>
                        <ul>
                            <li>„Çø„ÉÉ„Éó : ÂõûËª¢</li>
                            <li>Â∑¶Âè≥„Çπ„ÉØ„Ç§„Éó : ÁßªÂãï</li>
                            <li>‰∏ä„Çπ„ÉØ„Ç§„Éó : ‰∏ÄÊ∞ó„Å´ËêΩ‰∏ã</li>
                            <li>‰∏ã„Çπ„ÉØ„Ç§„Éó : È´òÈÄüËêΩ‰∏ã</li>
                        </ul>
                    </div>
                </div>
                <p style="margin-top: 10px; color: #888; font-size: 13px;">
                    ‚Äª „Çπ„Éû„Éõ„Åß„ÅØ„Éú„Çø„É≥Êìç‰Ωú„É¢„Éº„Éâ„ÇÇÈÅ∏Êäû„Åß„Åç„Åæ„Åô
                </p>
            </div>

            <div class="info-section">
                <h3>ü§ñ AIË¶≥Êà¶„É¢„Éº„Éâ</h3>
                <p>
                    AI„ÅåËá™Âãï„Åß„ÉÜ„Éà„É™„Çπ„Çí„Éó„É¨„Ç§„Åó„Åæ„Åô„ÄÇ<br>
                    „Å©„Çì„Å™Êà¶Áï•„ÅßÁ©ç„Åø‰∏ä„Åí„Çã„ÅãË¶≥ÂØü„Åó„Å¶„Åø„Çà„ÅÜÔºÅ<br>
                    AIÂ∞ÇÁî®„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„ÇÇË®òÈå≤„Åï„Çå„Åæ„Åô„ÄÇ
                </p>
            </div>

            <div class="info-section">
                <h3>üì± PWAÔºà„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†Ôºâ</h3>
                <p>
                    „Åì„ÅÆ„Ç≤„Éº„É†„ÅØPWAÂØæÂøú„Åß„Åô„ÄÇ<br>
                    „Çπ„Éû„Éõ„ÅÆ„Éñ„É©„Ç¶„Ç∂„É°„Éã„É•„Éº„Åã„Çâ„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Åô„Çã„Å®„ÄÅ<br>
                    „Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´„ÉØ„É≥„Çø„ÉÉ„Éó„ÅßËµ∑Âãï„Åß„Åç„Åæ„Åô„ÄÇ<br>
                    „Ç§„É≥„Çπ„Éà„Éº„É´‰∏çË¶Å„Åß„ÄÅ„Ç™„Éï„É©„Ç§„É≥„Åß„ÇÇÈÅä„Åπ„Åæ„Åô„ÄÇ
                </p>
            </div>

            <hr class="info-divider">

            <div class="info-contact">
                <p>„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Éª„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</p>
                <p style="margin-top: 5px; color: #666;">@NaK0528</p>
            </div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div class="game-container hidden" id="gameScreen">
        <h1>TETRIS-LIKE</h1>
        
        <div class="mode-info" id="modeInfo"></div>
        <div class="time-display" id="timeDisplay"></div>
        <div class="action-display" id="actionDisplay"></div>

        <div class="game-area">
            <canvas id="gameCanvas"></canvas>

            <div class="side-panel">
                <div class="panel-section">
                    <h3>NEXT</h3>
                    <canvas id="nextCanvas" width="120" height="120"></canvas>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„Çπ„Ç≥„Ç¢</div>
                    <div class="score-value" id="scoreDisplay">0</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É¨„Éô„É´</div>
                    <div class="score-value level-value" id="levelDisplay">1</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É©„Ç§„É≥</div>
                    <div class="score-value level-value" id="linesDisplay">0</div>
                </div>

                <div class="panel-section" id="controlTogglePanel">
                    <h3>Êìç‰ΩúÊñπÊ≥ï</h3>
                    <div class="toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" id="controlToggle" onchange="toggleControlMode()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-text">„Éú„Çø„É≥</span>
                    </div>
                    <div class="swipe-instructions" id="swipeInstructions">
                        <div class="swipe-title">„Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú</div>
                        <div>„Çø„ÉÉ„Éó: ÂõûËª¢</div>
                        <div>‚Üê ‚Üí: ÁßªÂãï</div>
                        <div>‚Üë: ‰∏ÄÊ∞ó„Å´ËêΩ‰∏ã</div>
                        <div>‚Üì: È´òÈÄüËêΩ‰∏ã</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="pause-button" id="pauseButton">‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="reset-button" id="restartButton" style="display:none;">üîÑ „É™„Çπ„Çø„Éº„Éà</button>
                    <button class="reset-button" id="resetButton">üè† „Éõ„Éº„É†</button>
                </div>
            </div>
        </div>

        <!-- „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ -->
        <div id="buttonControls" class="button-controls hidden">
            <div class="dpad-container">
                <!-- ÂçÅÂ≠ó„Ç≠„Éº -->
                <div class="dpad">
                    <div class="dpad-row">
                        <div class="dpad-empty"></div>
                        <button class="dpad-btn" id="upBtn">üîÑ<br><span style="font-size:10px;">ÂõûËª¢</span></button>
                        <div class="dpad-empty"></div>
                    </div>
                    <div class="dpad-row">
                        <button class="dpad-btn" id="leftBtn">‚óÄ</button>
                        <button class="dpad-center-btn" id="centerBtn">‚¨áÔ∏è</button>
                        <button class="dpad-btn" id="rightBtn">‚ñ∂</button>
                    </div>
                    <div class="dpad-row">
                        <div class="dpad-empty"></div>
                        <button class="dpad-btn" id="downBtn2">‚¨áÔ∏è<br><span style="font-size:10px;">ËêΩ‰∏ã</span></button>
                        <div class="dpad-empty"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameOverOverlay" class="overlay hidden">
        <div class="overlay-content game-over-overlay">
            <div class="overlay-title game-over-title">GAME OVER</div>
            <div class="overlay-score">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore">0</span></div>
            <button class="overlay-button" id="homeButton">üè† „Éõ„Éº„É†„Å´Êàª„Çã</button>
        </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
        <div class="overlay-content pause-overlay">
            <div class="overlay-title pause-title">‰∏ÄÊôÇÂÅúÊ≠¢</div>
            <div class="overlay-score">„Çø„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÈñã</div>
            <button class="overlay-button" onclick="game.togglePause()">‚ñ∂ ÂÜçÈñã</button>
        </div>
    </div>

    <script>
        // ===========================================
        // ÂÆöÊï∞ÂÆöÁæ©
        // ===========================================
        const TETROMINO_TYPES = {
            I: { shape: [[1, 1, 1, 1]], color: '#00ffff' },
            O: { shape: [[1, 1], [1, 1]], color: '#ffff00' },
            T: { shape: [[0, 1, 0], [1, 1, 1]], color: '#800080' },
            S: { shape: [[0, 1, 1], [1, 1, 0]], color: '#00ff00' },
            Z: { shape: [[1, 1, 0], [0, 1, 1]], color: '#ff0000' },
            J: { shape: [[1, 0, 0], [1, 1, 1]], color: '#0000ff' },
            L: { shape: [[0, 0, 1], [1, 1, 1]], color: '#ff8800' }
        };

        const GAME_STATES = {
            PLAYING: 'PLAYING',
            LINE_CLEARING: 'LINE_CLEARING',
            GAME_OVER: 'GAME_OVER',
            PAUSED: 'PAUSED'
        };

        // ===========================================
        // „Éú„Éº„ÉâË®≠ÂÆö„Å®Â∫ßÊ®ôÁ≥ª
        // ===========================================
        // 
        // „ÄêÂ∫ßÊ®ôÁ≥ª„ÅÆË™¨Êòé„Äë
        // - „Éî„Éº„ÇπÂ∫ßÊ®ô(y): -2„Äú19 „ÅÆÁØÑÂõ≤„ÅßÂãï‰Ωú
        //   - y < 0: „Éê„ÉÉ„Éï„Ç°È†òÂüüÔºàÁîªÈù¢Â§ñ„ÉªÈùûË°®Á§∫Ôºâ
        //   - y >= 0: Ë°®Á§∫È†òÂüüÔºàÁîªÈù¢ÂÜÖÔºâ
        //
        // - „Éú„Éº„ÉâÈÖçÂàó„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ(boardY): 0„Äú21
        //   - boardY = y + BUFFER_HEIGHT
        //   - boardY 0„Äú1: „Éê„ÉÉ„Éï„Ç°ÔºàÈùûË°®Á§∫Ôºâ
        //   - boardY 2„Äú21: Ë°®Á§∫È†òÂüü
        //
        // „Äê„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊù°‰ª∂„Äë
        // - „Éñ„É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: Êñ∞„Éî„Éº„Çπ„Åå„Çπ„Éù„Éº„É≥ÊôÇ„Å´Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å®Ë°ùÁ™Å
        // - „É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: „Éî„Éº„Çπ„Åå„Éê„ÉÉ„Éï„Ç°ÂÜÖÔºàboardY < 2Ôºâ„Å´Âõ∫ÂÆö„Åï„Çå„Åü
        //
        const BOARD_WIDTH = 10;
        const BOARD_HEIGHT = 20;        // Ë°®Á§∫È†òÂüü„ÅÆÈ´ò„Åï
        const BUFFER_HEIGHT = 2;        // ‰∏ä„Éê„ÉÉ„Éï„Ç°„ÅÆÈ´ò„ÅïÔºàÊú¨ÂÆ∂„ÉÜ„Éà„É™„Çπ‰ªïÊßòÔºâ
        const TOTAL_HEIGHT = BOARD_HEIGHT + BUFFER_HEIGHT;  // „Éú„Éº„ÉâÈÖçÂàó„ÅÆÁ∑èÈ´ò„ÅïÔºà22Ôºâ
        const LINE_CLEAR_FRAMES = 12;
        const SPRINT_DURATION_MS = 60000;

        // ===========================================
        // Tetromino„ÇØ„É©„Çπ
        // ===========================================
        class Tetromino {
            constructor(type) {
                this.type = type;
                this.shape = JSON.parse(JSON.stringify(TETROMINO_TYPES[type].shape));
                this.color = TETROMINO_TYPES[type].color;
                // „Çπ„Éù„Éº„É≥‰ΩçÁΩÆ: y=-1Ôºà„Éê„ÉÉ„Éï„Ç°ÂÜÖÔºâ„Åã„ÇâÈñãÂßã
                // „Éî„Éº„Çπ„ÅÆ‰∏ãÈÉ®„ÅåÁîªÈù¢‰∏äÁ´Ø(y=0)‰ªòËøë„Å´Áèæ„Çå„Çã
                this.position = { x: 3, y: -1 };
            }

            rotate() {
                const rows = this.shape.length;
                const cols = this.shape[0].length;
                const newShape = [];

                for (let j = 0; j < cols; j++) {
                    const newRow = [];
                    for (let i = rows - 1; i >= 0; i--) {
                        newRow.push(this.shape[i][j]);
                    }
                    newShape.push(newRow);
                }

                const rotated = new Tetromino(this.type);
                rotated.shape = newShape;
                rotated.position = { ...this.position };
                return rotated;
            }

            clone() {
                const cloned = new Tetromino(this.type);
                cloned.shape = JSON.parse(JSON.stringify(this.shape));
                cloned.position = { ...this.position };
                return cloned;
            }
        }

        // ===========================================
        // TetrisGame„ÇØ„É©„Çπ
        // ===========================================
        class TetrisGame {
            constructor(mode = 'normal', aiEnabled = false) {
                this.mode = mode;
                this.isAIMode = aiEnabled;  // AI„É¢„Éº„Éâ„Éï„É©„Ç∞
                this.blockSize = this.calculateBlockSize();
                
                // „Ç≠„É£„É≥„Éê„ÇπÂàùÊúüÂåñ
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = BOARD_WIDTH * this.blockSize;
                this.canvas.height = BOARD_HEIGHT * this.blockSize;

                this.nextCanvas = document.getElementById('nextCanvas');
                this.nextCtx = this.nextCanvas.getContext('2d');

                // „Ç≤„Éº„É†Áä∂ÊÖãÂàùÊúüÂåñ
                this.initializeGameState();
                
                // „Ç≤„Éº„É†ÈñãÂßã
                this.init();
                this.updateModeInfo();
            }

            initializeGameState() {
                this.board = [];
                this.currentPiece = null;
                this.nextPieceType = null;
                this.pieceBag = [];
                
                this.score = 0;
                this.level = 1;
                this.linesCleared = 0;
                
                this.gameState = GAME_STATES.PLAYING;
                this.isGameOver = false;
                this.isPaused = false;
                
                this.lastMoveWasRotation = false;
                this.lastAction = '';
                
                // „Çø„Ç§„Éû„ÉºÈñ¢ÈÄ£
                this.startTime = null;
                this.elapsedTime = 0;
                this.timerInterval = null;
                this.timerStarted = false;
                this.pausedTime = 0;  // ‰∏ÄÊôÇÂÅúÊ≠¢ÊôÇ„ÅÆÁµåÈÅéÊôÇÈñì„Çí‰øùÂ≠ò
                
                // „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà
                this.lineClearData = null;
                this.flashingLines = [];
                this.flashCounter = 0;
                
                // „Ç≤„Éº„É†„É´„Éº„Éó
                this.lastUpdateTime = 0;
                this.dropTimer = 0;
                this.animationFrameId = null;
                
                // ÁõÆÊ®ô„É©„Ç§„É≥Êï∞
                this.targetLines = this.getTargetLines();
                
                // AIÈñ¢ÈÄ£ÔºàisAIMode„ÅØ„Ç≥„É≥„Çπ„Éà„É©„ÇØ„Çø„ÅßË®≠ÂÆöÊ∏à„ÅøÔºâ
                this.ai = null;
                this.aiMoveQueue = [];
                this.aiMoveTimer = 0;
                this.aiMoveInterval = 10;  // AI„ÅÆÂãï‰ΩúÈñìÈöîÔºàmsÔºâ
            }

            getTargetLines() {
                const targets = {
                    'time10': 10,
                    'time20': 20,
                    'time40': 40,
                    'time100': 100,
                    'sprint1m': Infinity
                };
                return targets[this.mode] || null;
            }

            calculateBlockSize() {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    const availableWidth = window.innerWidth - 120;
                    const blockSize = Math.floor(availableWidth / BOARD_WIDTH);
                    return Math.min(Math.max(blockSize, 20), 30);
                }
                return 25;
            }

            updateModeInfo() {
                const modeInfo = document.getElementById('modeInfo');
                const restartButton = document.getElementById('restartButton');
                const controlPanel = document.getElementById('controlTogglePanel');
                
                const modeTexts = {
                    'normal': 'üìä „Éé„Éº„Éû„É´„É¢„Éº„Éâ',
                    'sprint1m': '‚ö° 1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà',
                    'time10': '‚è±Ô∏è 10„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time20': '‚è±Ô∏è 20„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time40': '‚è±Ô∏è 40„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time100': '‚è±Ô∏è 100„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ'
                };
                
                let displayText = modeTexts[this.mode] || '';
                
                // AI„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÊé•È†≠Ëæû„ÇíËøΩÂä†
                if (this.isAIMode) {
                    displayText = 'ü§ñ AI ' + displayText;
                }
                
                modeInfo.textContent = displayText;
                restartButton.style.display = (this.mode === 'normal') ? 'none' : 'block';
                
                // AI„É¢„Éº„Éâ„Åß„ÅØÊìç‰Ωú„Éë„Éç„É´„ÇíÈùûË°®Á§∫
                if (controlPanel) {
                    controlPanel.style.display = this.isAIMode ? 'none' : 'block';
                }
            }

            // ===========================================
            // ÂàùÊúüÂåñ
            // ===========================================
            init() {
                // „Éú„Éº„ÉâÈÖçÂàó: 22Ë°åÔºà‰∏ä2Ë°å„Éê„ÉÉ„Éï„Ç° + Ë°®Á§∫20Ë°åÔºâ
                this.board = Array(TOTAL_HEIGHT).fill(null).map(() => 
                    Array(BOARD_WIDTH).fill(null)
                );

                this.fillPieceBag();
                this.nextPieceType = this.getNextPieceFromBag();
                this.spawnNewPiece();
                this.drawNext();
                
                // AI„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØAI„ÇíÂàùÊúüÂåñ
                if (this.isAIMode) {
                    this.ai = new TetrisAI(this);
                    this.planAIMove();
                }
                
                this.lastUpdateTime = performance.now();
                this.startGameLoop();
            }

            fillPieceBag() {
                const types = Object.keys(TETROMINO_TYPES);
                this.pieceBag = [...types];
                // Fisher-Yates„Ç∑„É£„ÉÉ„Éï„É´
                for (let i = this.pieceBag.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.pieceBag[i], this.pieceBag[j]] = [this.pieceBag[j], this.pieceBag[i]];
                }
            }

            getNextPieceFromBag() {
                if (this.pieceBag.length === 0) {
                    this.fillPieceBag();
                }
                return this.pieceBag.shift();
            }

            // ===========================================
            // „Çø„Ç§„Éû„ÉºÁÆ°ÁêÜ
            // ===========================================
            startTimer() {
                if (this.timerInterval !== null) {
                    return;
                }
                
                // ‰∏ÄÊôÇÂÅúÊ≠¢„Åã„ÇâÂÜçÈñã„Åô„ÇãÂ†¥Âêà„ÅØstartTime„ÇíË™øÊï¥
                this.startTime = Date.now() - this.pausedTime;
                this.timerStarted = true;
                
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused && !this.isGameOver) {
                        this.elapsedTime = Date.now() - this.startTime;
                        this.updateTimeDisplay();
                        
                        // 1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà: ÊôÇÈñìÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
                        if (this.mode === 'sprint1m' && this.elapsedTime >= SPRINT_DURATION_MS) {
                            this.endSprintMode();
                        }
                    }
                }, 10);
            }
            
            pauseTimer() {
                if (this.timerInterval !== null) {
                    // ÁèæÂú®„ÅÆÁµåÈÅéÊôÇÈñì„Çí‰øùÂ≠ò
                    this.pausedTime = this.elapsedTime;
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }
            
            resumeTimer() {
                if (this.timerInterval === null && this.timerStarted) {
                    // ‰øùÂ≠ò„Åï„Çå„ÅüÁµåÈÅéÊôÇÈñì„Åã„ÇâstartTime„ÇíÂÜçË®àÁÆó
                    this.startTime = Date.now() - this.pausedTime;
                    
                    this.timerInterval = setInterval(() => {
                        if (!this.isPaused && !this.isGameOver) {
                            this.elapsedTime = Date.now() - this.startTime;
                            this.updateTimeDisplay();
                            
                            // 1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà: ÊôÇÈñìÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
                            if (this.mode === 'sprint1m' && this.elapsedTime >= SPRINT_DURATION_MS) {
                                this.endSprintMode();
                            }
                        }
                    }, 10);
                }
            }
            
            stopTimer() {
                if (this.timerInterval !== null) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            updateTimeDisplay() {
                const timeDisplay = document.getElementById('timeDisplay');
                const totalSeconds = this.elapsedTime / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds % 1) * 1000);
                
                if (this.mode === 'normal') {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
                }
            }

            // ===========================================
            // „Ç≤„Éº„É†„É´„Éº„Éó
            // ===========================================
            startGameLoop() {
                const gameLoop = (currentTime) => {
                    if (this.isGameOver) {
                        return;
                    }

                    const deltaTime = currentTime - this.lastUpdateTime;
                    this.lastUpdateTime = currentTime;

                    if (!this.isPaused) {
                        this.update(deltaTime);
                    }

                    this.draw();
                    this.animationFrameId = requestAnimationFrame(gameLoop);
                };

                this.animationFrameId = requestAnimationFrame(gameLoop);
            }

            update(deltaTime) {
                // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´„Çø„Ç§„Éû„Éº„Çπ„Çø„Éº„Éà
                if (!this.timerStarted && this.currentPiece !== null) {
                    this.startTimer();
                }
                
                // „É©„Ç§„É≥Ê∂àÂéª‰∏≠„ÅÆÂá¶ÁêÜ
                if (this.gameState === GAME_STATES.LINE_CLEARING) {
                    if (this.lineClearData !== null) {
                        this.lineClearData.frameCount++;
                        if (this.lineClearData.frameCount >= LINE_CLEAR_FRAMES) {
                            this.completeClearLines();
                        }
                    }
                    return;
                }
                
                // AI„É¢„Éº„Éâ„ÅÆÂá¶ÁêÜ
                if (this.isAIMode && this.gameState === GAME_STATES.PLAYING && this.currentPiece !== null) {
                    this.updateAI(deltaTime);
                    return;  // AI„É¢„Éº„Éâ„Åß„ÅØÈÄöÂ∏∏„ÅÆËêΩ‰∏ãÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó
                }
                
                // ÈÄöÂ∏∏„Éó„É¨„Ç§‰∏≠„ÅÆËêΩ‰∏ãÂá¶ÁêÜ
                if (this.gameState === GAME_STATES.PLAYING && this.currentPiece !== null) {
                    const dropInterval = Math.max(200, 700 - (this.level - 1) * 50);
                    this.dropTimer += deltaTime;
                    
                    if (this.dropTimer >= dropInterval) {
                        this.dropTimer = 0;
                        this.moveDown(false);
                    }
                }
            }
            
            // AIÊõ¥Êñ∞Âá¶ÁêÜ
            updateAI(deltaTime) {
                this.aiMoveTimer += deltaTime;
                
                // ‰∏ÄÂÆöÈñìÈöî„ÅßAI„ÅÆÂãï‰Ωú„ÇíÂÆüË°å
                if (this.aiMoveTimer >= this.aiMoveInterval) {
                    this.aiMoveTimer = 0;
                    
                    if (this.aiMoveQueue.length > 0) {
                        // „Ç≠„É•„Éº„Åã„ÇâÊ¨°„ÅÆÂãï‰Ωú„ÇíÂèñ„ÇäÂá∫„Åó„Å¶ÂÆüË°å
                        const move = this.aiMoveQueue.shift();
                        this.executeAIMove(move);
                    } else {
                        // „Ç≠„É•„Éº„ÅåÁ©∫„Å™„ÇâÊ¨°„ÅÆÊâã„ÇíË®àÁîª
                        this.planAIMove();
                    }
                }
            }
            
            // AI„ÅÆÊ¨°„ÅÆÊâã„ÇíË®àÁîª
            planAIMove() {
                if (!this.ai || !this.currentPiece) {
                    return;
                }
                
                const bestMove = this.ai.findBestMove();
                if (bestMove) {
                    this.aiMoveQueue = this.ai.generateMoveQueue(bestMove);
                } else {
                    // ÊúÄÂñÑÊâã„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„Å®„Çä„ÅÇ„Åà„Åö„Éâ„É≠„ÉÉ„Éó
                    this.aiMoveQueue = ['drop'];
                }
            }
            
            // AI„ÅÆÂãï‰Ωú„ÇíÂÆüË°å
            executeAIMove(move) {
                if (!this.currentPiece) {
                    return;
                }
                
                switch (move) {
                    case 'left':
                        this.moveLeftInternal();
                        break;
                    case 'right':
                        this.moveRightInternal();
                        break;
                    case 'rotate':
                        this.rotateInternal();
                        break;
                    case 'drop':
                        this.hardDropInternal();
                        break;
                }
            }
            
            // AIÁî®„ÅÆÂÜÖÈÉ®ÁßªÂãï„É°„ÇΩ„ÉÉ„ÉâÔºà„Ç¨„Éº„ÉâÊù°‰ª∂„Å™„ÅóÔºâ
            moveLeftInternal() {
                if (!this.currentPiece) return;
                if (!this.checkCollision(this.currentPiece, -1, 0)) {
                    this.currentPiece.position.x--;
                    this.lastMoveWasRotation = false;
                }
            }
            
            moveRightInternal() {
                if (!this.currentPiece) return;
                if (!this.checkCollision(this.currentPiece, 1, 0)) {
                    this.currentPiece.position.x++;
                    this.lastMoveWasRotation = false;
                }
            }
            
            rotateInternal() {
                if (!this.currentPiece) return;
                
                const rotated = this.currentPiece.rotate();
                
                if (!this.checkCollision(rotated, 0, 0)) {
                    this.currentPiece = rotated;
                    this.lastMoveWasRotation = true;
                    return;
                }

                // Â£Å„Ç≠„ÉÉ„ÇØ
                const kickTests = [[-1, 0], [1, 0], [0, -1], [-1, -1], [1, -1]];
                for (const [kickX, kickY] of kickTests) {
                    const kicked = rotated.clone();
                    kicked.position.x += kickX;
                    kicked.position.y += kickY;

                    if (!this.checkCollision(kicked, 0, 0)) {
                        this.currentPiece = kicked;
                        this.lastMoveWasRotation = true;
                        return;
                    }
                }
            }
            
            hardDropInternal() {
                if (!this.currentPiece) return;
                
                while (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                }
                this.lastMoveWasRotation = false;
                this.lockPiece();
            }

            // ===========================================
            // „Éî„Éº„ÇπÊìç‰Ωú
            // ===========================================
            spawnNewPiece() {
                if (this.isGameOver) {
                    return;
                }

                const newPiece = new Tetromino(this.nextPieceType);
                this.nextPieceType = this.getNextPieceFromBag();
                this.drawNext();

                if (this.checkCollision(newPiece, 0, 0)) {
                    this.triggerGameOver();
                } else {
                    this.currentPiece = newPiece;
                    this.gameState = GAME_STATES.PLAYING;
                    
                    // AI„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÊñ∞„Åó„ÅÑ„Éî„Éº„Çπ„ÅÆÊâã„ÇíË®àÁîª
                    if (this.isAIMode && this.ai) {
                        this.aiMoveQueue = [];
                        this.planAIMove();
                    }
                }
            }

            checkCollision(piece, offsetX, offsetY) {
                if (!piece || !piece.shape) {
                    return true;
                }
                
                for (let i = 0; i < piece.shape.length; i++) {
                    for (let j = 0; j < piece.shape[i].length; j++) {
                        if (piece.shape[i][j] === 1) {
                            const x = piece.position.x + j + offsetX;
                            const y = piece.position.y + i + offsetY;
                            const boardY = y + BUFFER_HEIGHT;

                            // Â∑¶Âè≥„ÅÆÂ£Å„ÉªÂ∫ï„Å®„ÅÆË°ùÁ™Å
                            if (x < 0 || x >= BOARD_WIDTH || boardY >= TOTAL_HEIGHT) {
                                return true;
                            }

                            // „Éê„ÉÉ„Éï„Ç°„Çà„Çä‰∏ä„ÅØË°ùÁ™Å„Å™„ÅóÔºà„Çπ„Éù„Éº„É≥ÊôÇ„ÅÆ„ÅøÁô∫ÁîüÔºâ
                            if (boardY < 0) {
                                continue;
                            }

                            // Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å®„ÅÆË°ùÁ™Å
                            if (this.board[boardY] && this.board[boardY][x] !== null) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            moveLeft() {
                // AI„É¢„Éº„Éâ„Åß„ÅØ‰∫∫Èñì„ÅÆÊìç‰Ωú„ÇíÁÑ°ÂäπÂåñ
                if (this.isAIMode) return;
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, -1, 0)) {
                    this.currentPiece.position.x--;
                    this.lastMoveWasRotation = false;
                }
            }

            moveRight() {
                // AI„É¢„Éº„Éâ„Åß„ÅØ‰∫∫Èñì„ÅÆÊìç‰Ωú„ÇíÁÑ°ÂäπÂåñ
                if (this.isAIMode) return;
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, 1, 0)) {
                    this.currentPiece.position.x++;
                    this.lastMoveWasRotation = false;
                }
            }

            rotate() {
                // AI„É¢„Éº„Éâ„Åß„ÅØ‰∫∫Èñì„ÅÆÊìç‰Ωú„ÇíÁÑ°ÂäπÂåñ
                if (this.isAIMode) return;
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                const rotated = this.currentPiece.rotate();
                
                if (!this.checkCollision(rotated, 0, 0)) {
                    this.currentPiece = rotated;
                    this.lastMoveWasRotation = true;
                    return;
                }

                // Super Rotation System (SRS) - Â£Å„Ç≠„ÉÉ„ÇØ
                const kickTests = [[-1, 0], [1, 0], [0, -1], [-1, -1], [1, -1]];

                for (const [kickX, kickY] of kickTests) {
                    const kicked = rotated.clone();
                    kicked.position.x += kickX;
                    kicked.position.y += kickY;

                    if (!this.checkCollision(kicked, 0, 0)) {
                        this.currentPiece = kicked;
                        this.lastMoveWasRotation = true;
                        return;
                    }
                }
            }

            hardDrop() {
                // AI„É¢„Éº„Éâ„Åß„ÅØ‰∫∫Èñì„ÅÆÊìç‰Ωú„ÇíÁÑ°ÂäπÂåñ
                if (this.isAIMode) return;
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                while (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                }
                this.lastMoveWasRotation = false;
                this.lockPiece();
            }

            moveDown(manual = false) {
                // AI„É¢„Éº„Éâ„Åß„ÅØ‰∫∫Èñì„ÅÆÊìç‰Ωú„ÇíÁÑ°ÂäπÂåñ
                if (this.isAIMode && manual) return;
                if (!this.currentPiece || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                    if (manual) {
                        this.lastMoveWasRotation = false;
                    }
                } else {
                    this.lockPiece();
                }
            }

            // ===========================================
            // „Éî„Éº„ÇπÂõ∫ÂÆö„Å®„É©„Ç§„É≥Ê∂àÂéª
            // ===========================================
            lockPiece() {
                if (!this.currentPiece) {
                    return;
                }

                const isTSpin = this.checkTSpin(this.currentPiece);
                let lockedInBuffer = false;

                // „Éú„Éº„Éâ„Å´„Éî„Éº„Çπ„ÇíÂõ∫ÂÆö
                for (let i = 0; i < this.currentPiece.shape.length; i++) {
                    for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                        if (this.currentPiece.shape[i][j] === 1) {
                            const x = this.currentPiece.position.x + j;
                            const y = this.currentPiece.position.y + i;
                            const boardY = y + BUFFER_HEIGHT;
                            
                            if (boardY >= 0 && boardY < TOTAL_HEIGHT && x >= 0 && x < BOARD_WIDTH) {
                                this.board[boardY][x] = this.currentPiece.color;
                                
                                // „Éê„ÉÉ„Éï„Ç°ÂÜÖ„Å´Âõ∫ÂÆö„Åï„Çå„Åü„ÅãÂà§ÂÆöÔºà„É≠„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÊù°‰ª∂Ôºâ
                                if (boardY < BUFFER_HEIGHT) {
                                    lockedInBuffer = true;
                                }
                            }
                        }
                    }
                }

                this.currentPiece = null;
                this.lastMoveWasRotation = false;

                // „É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: „Éê„ÉÉ„Éï„Ç°ÂÜÖ„Å´„Éñ„É≠„ÉÉ„ÇØ„ÅåÊÆã„Å£„ÅüÂ†¥Âêà„ÅØ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                if (lockedInBuffer) {
                    this.triggerGameOver();
                    return;
                }

                this.processLineClear(isTSpin);
            }

            checkTSpin(piece) {
                if (piece.type !== 'T' || !this.lastMoveWasRotation) {
                    return false;
                }

                const x = piece.position.x;
                const y = piece.position.y;
                const corners = [[x, y], [x + 2, y], [x, y + 2], [x + 2, y + 2]];
                let filledCorners = 0;

                for (const [cx, cy] of corners) {
                    const boardY = cy + BUFFER_HEIGHT;
                    
                    // Â£Å„ÉªÁØÑÂõ≤Â§ñ„ÉªÊó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„ÅØfilled„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà
                    if (cx < 0 || cx >= BOARD_WIDTH || boardY < 0 || boardY >= TOTAL_HEIGHT) {
                        filledCorners++;
                    } else if (this.board[boardY] && this.board[boardY][cx] !== null) {
                        filledCorners++;
                    }
                }

                return filledCorners >= 3;
            }

            processLineClear(isTSpin) {
                const linesToClear = [];

                // Ë°®Á§∫È†òÂüü„ÅÆ„Åø„É©„Ç§„É≥„ÇØ„É™„Ç¢Âà§ÂÆöÔºà„Éê„ÉÉ„Éï„Ç°„ÅØÂØæË±°Â§ñÔºâ
                for (let boardY = BUFFER_HEIGHT; boardY < TOTAL_HEIGHT; boardY++) {
                    if (this.board[boardY].every(cell => cell !== null)) {
                        linesToClear.push(boardY);
                    }
                }

                if (linesToClear.length > 0) {
                    this.gameState = GAME_STATES.LINE_CLEARING;
                    this.lineClearData = {
                        lines: linesToClear,
                        isTSpin: isTSpin,
                        count: linesToClear.length,
                        frameCount: 0
                    };
                    this.flashingLines = linesToClear;
                    this.flashCounter = 0;
                } else {
                    this.spawnNewPiece();
                }
            }
            
            completeClearLines() {
                const data = this.lineClearData;
                if (!data) {
                    this.gameState = GAME_STATES.PLAYING;
                    this.spawnNewPiece();
                    return;
                }

                // Ê∂àÂéªÂØæË±°‰ª•Â§ñ„ÅÆ„É©„Ç§„É≥„Çí‰øùÊåÅ
                const newBoard = [];
                for (let boardY = 0; boardY < TOTAL_HEIGHT; boardY++) {
                    if (!data.lines.includes(boardY)) {
                        newBoard.push(this.board[boardY]);
                    }
                }

                // ‰∏äÈÉ®„Å´Á©∫„ÅÆ„É©„Ç§„É≥„ÇíËøΩÂä†
                while (newBoard.length < TOTAL_HEIGHT) {
                    newBoard.unshift(Array(BOARD_WIDTH).fill(null));
                }

                this.board = newBoard;

                // „Çπ„Ç≥„Ç¢Ë®àÁÆó
                const scoreTable = { 1: 25, 2: 100, 3: 400, 4: 1600 };
                const lineScore = scoreTable[data.count] || 25;
                this.score += lineScore * (this.level + 1);
                
                // T„Çπ„Éî„É≥„Éú„Éº„Éä„Çπ
                if (data.isTSpin && data.count > 0) {
                    const bonus = data.count * 400 * this.level;
                    this.score += bonus;
                    const spinTypes = { 1: 'SINGLE', 2: 'DOUBLE', 3: 'TRIPLE' };
                    this.showAction(`T-SPIN ${spinTypes[data.count] || ''}! +${bonus}`);
                } else if (data.count === 4) {
                    const bonus = 800 * this.level;
                    this.score += bonus;
                    this.showAction(`TETRIS! +${bonus}`);
                }

                this.linesCleared += data.count;

                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó
                const newLevel = Math.floor(this.linesCleared / 10) + 1;
                if (newLevel > this.level) {
                    this.level = newLevel;
                }

                this.updateDisplay();

                // „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.targetLines !== null && this.targetLines !== Infinity && this.linesCleared >= this.targetLines) {
                    this.completeTimeAttack();
                    return;
                }

                // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà„Åó„Å¶Ê¨°„ÅÆ„Éî„Éº„Çπ„ÇíÁîüÊàê
                this.flashingLines = [];
                this.flashCounter = 0;
                this.lineClearData = null;
                this.gameState = GAME_STATES.PLAYING;
                this.spawnNewPiece();
            }

            // ===========================================
            // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
            // ===========================================
            triggerGameOver() {
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                // „Éé„Éº„Éû„É´„É¢„Éº„Éâ„ÅØ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„Åß„ÇÇË®òÈå≤‰øùÂ≠ò
                if (this.mode === 'normal') {
                    this.saveRecord();
                }
                this.showGameOver();
            }

            endSprintMode() {
                if (this.isGameOver) {
                    return;
                }
                
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                this.saveRecord();
                this.showSprintComplete();
            }

            completeTimeAttack() {
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                this.saveRecord();
                this.showTimeAttackComplete();
            }

            saveRecord() {
                const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
                
                // AI„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÂà•„ÅÆ„Ç≠„Éº„Å´‰øùÂ≠òÔºà‰æã: normal_ai, sprint1m_aiÔºâ
                const recordKey = this.isAIMode ? `${this.mode}_ai` : this.mode;
                
                if (!records[recordKey]) {
                    records[recordKey] = [];
                }

                const record = {
                    mode: this.mode,
                    isAI: this.isAIMode,
                    date: new Date().toISOString()
                };

                if (this.mode === 'normal') {
                    record.score = this.score;
                } else if (this.mode === 'sprint1m') {
                    record.lines = this.linesCleared;
                } else {
                    record.time = this.elapsedTime;
                }

                records[recordKey].push(record);
                records[recordKey].sort((a, b) => {
                    if (this.mode === 'normal') {
                        return b.score - a.score;
                    } else if (this.mode === 'sprint1m') {
                        return b.lines - a.lines;
                    }
                    return a.time - b.time;
                });
                records[recordKey] = records[recordKey].slice(0, 10);

                localStorage.setItem('tetrisRecords', JSON.stringify(records));
            }

            showGameOver() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'GAME OVER';
                title.style.color = '#ff0000';
                
                document.getElementById('finalScore').textContent = this.score.toLocaleString() + ' ÁÇπ';
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            showSprintComplete() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'ÊôÇÈñìÂàá„Çå!';
                title.style.color = '#00ff00';
                
                document.getElementById('finalScore').textContent = `${this.linesCleared} „É©„Ç§„É≥`;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            showTimeAttackComplete() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'COMPLETE!';
                title.style.color = '#00ff00';
                
                const timeStr = this.formatTime(this.elapsedTime);
                document.getElementById('finalScore').textContent = timeStr;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            formatTime(milliseconds) {
                const totalSeconds = milliseconds / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const ms = Math.floor((totalSeconds % 1) * 1000);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }

            // ===========================================
            // ÊèèÁîª
            // ===========================================
            draw() {
                this.ctx.fillStyle = '#1e293b';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Âõ∫ÂÆö„Éñ„É≠„ÉÉ„ÇØ„ÅÆÊèèÁîªÔºàË°®Á§∫È†òÂüü„ÅÆ„ÅøÔºâ
                for (let screenY = 0; screenY < BOARD_HEIGHT; screenY++) {
                    const boardY = screenY + BUFFER_HEIGHT;
                    for (let x = 0; x < BOARD_WIDTH; x++) {
                        if (this.board[boardY] && this.board[boardY][x]) {
                            // „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà
                            if (this.gameState === GAME_STATES.LINE_CLEARING && 
                                this.flashingLines.includes(boardY) && 
                                this.flashCounter < 6) {
                                this.ctx.fillStyle = '#ffffff';
                                this.ctx.shadowBlur = 15;
                                this.ctx.shadowColor = '#ffffff';
                                this.ctx.fillRect(
                                    x * this.blockSize,
                                    screenY * this.blockSize,
                                    this.blockSize,
                                    this.blockSize
                                );
                                this.ctx.shadowBlur = 0;
                            } else {
                                this.drawBlock(x, screenY, this.board[boardY][x]);
                            }
                        } else {
                            this.drawEmptyBlock(x, screenY);
                        }
                    }
                }
                
                if (this.gameState === GAME_STATES.LINE_CLEARING) {
                    this.flashCounter++;
                }

                // „Ç¥„Éº„Çπ„Éà„Å®„Ç´„É¨„É≥„Éà„Éî„Éº„Çπ„ÅÆÊèèÁîª
                if (this.currentPiece) {
                    // „Ç¥„Éº„Çπ„ÉàÔºàËêΩ‰∏ã‰ΩçÁΩÆ„Éó„É¨„Éì„É•„ÉºÔºâ
                    const ghost = this.getGhostPosition();
                    if (ghost) {
                        for (let i = 0; i < ghost.shape.length; i++) {
                            for (let j = 0; j < ghost.shape[i].length; j++) {
                                if (ghost.shape[i][j] === 1) {
                                    const x = ghost.position.x + j;
                                    const y = ghost.position.y + i;
                                    if (y >= 0) {
                                        this.ctx.fillStyle = this.currentPiece.color + '40';
                                        this.ctx.fillRect(
                                            x * this.blockSize,
                                            y * this.blockSize,
                                            this.blockSize,
                                            this.blockSize
                                        );
                                        this.ctx.strokeStyle = this.currentPiece.color + 'AA';
                                        this.ctx.lineWidth = 2;
                                        this.ctx.strokeRect(
                                            x * this.blockSize,
                                            y * this.blockSize,
                                            this.blockSize,
                                            this.blockSize
                                        );
                                    }
                                }
                            }
                        }
                    }

                    // „Ç´„É¨„É≥„Éà„Éî„Éº„Çπ
                    for (let i = 0; i < this.currentPiece.shape.length; i++) {
                        for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                            if (this.currentPiece.shape[i][j] === 1) {
                                const x = this.currentPiece.position.x + j;
                                const y = this.currentPiece.position.y + i;
                                if (y >= 0) {
                                    this.drawBlock(x, y, this.currentPiece.color);
                                }
                            }
                        }
                    }
                }
            }

            drawBlock(x, y, color) {
                this.ctx.shadowBlur = 3;
                this.ctx.shadowColor = color;
                
                this.ctx.fillStyle = color;
                this.ctx.fillRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.fillRect(
                    x * this.blockSize + 2,
                    y * this.blockSize + 2,
                    this.blockSize - 4,
                    this.blockSize - 4
                );
                
                this.ctx.shadowBlur = 0;
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
            }

            drawEmptyBlock(x, y) {
                this.ctx.fillStyle = 'rgba(71, 85, 105, 0.1)';
                this.ctx.fillRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
                this.ctx.strokeStyle = 'rgba(71, 85, 105, 0.2)';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
            }

            getGhostPosition() {
                if (!this.currentPiece) {
                    return null;
                }

                const ghost = this.currentPiece.clone();
                while (!this.checkCollision(ghost, 0, 1)) {
                    ghost.position.y++;
                }
                return ghost;
            }

            drawNext() {
                this.nextCtx.fillStyle = '#1e293b';
                this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);

                if (!this.nextPieceType) {
                    return;
                }

                const nextPiece = new Tetromino(this.nextPieceType);
                const blockSize = 25;
                const shape = nextPiece.shape;
                
                const totalWidth = shape[0].length * blockSize;
                const totalHeight = shape.length * blockSize;
                const offsetX = (this.nextCanvas.width - totalWidth) / 2;
                const offsetY = (this.nextCanvas.height - totalHeight) / 2;

                for (let i = 0; i < shape.length; i++) {
                    for (let j = 0; j < shape[i].length; j++) {
                        if (shape[i][j] === 1) {
                            this.nextCtx.fillStyle = nextPiece.color;
                            this.nextCtx.fillRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                            this.nextCtx.strokeStyle = '#000';
                            this.nextCtx.lineWidth = 2;
                            this.nextCtx.strokeRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                        }
                    }
                }
            }

            showAction(text) {
                this.lastAction = text;
                const display = document.getElementById('actionDisplay');
                display.innerHTML = `<div class="action-text">${text}</div>`;

                setTimeout(() => {
                    display.innerHTML = '';
                }, 3000);
            }

            updateDisplay() {
                document.getElementById('scoreDisplay').textContent = this.score.toLocaleString();
                document.getElementById('levelDisplay').textContent = this.level;
                document.getElementById('linesDisplay').textContent = this.linesCleared;
            }

            // ===========================================
            // „Ç≤„Éº„É†Âà∂Âæ°
            // ===========================================
            togglePause() {
                if (this.isGameOver) {
                    return;
                }

                this.isPaused = !this.isPaused;
                const pauseOverlay = document.getElementById('pauseOverlay');
                const pauseButton = document.getElementById('pauseButton');

                if (this.isPaused) {
                    this.pauseTimer();  // „Çø„Ç§„Éû„Éº„Çí‰∏ÄÊôÇÂÅúÊ≠¢
                    pauseOverlay.classList.remove('hidden');
                    pauseButton.textContent = '‚ñ∂ ÂÜçÈñã';
                    pauseOverlay.onclick = () => this.togglePause();
                } else {
                    this.resumeTimer();  // „Çø„Ç§„Éû„Éº„ÇíÂÜçÈñã
                    pauseOverlay.classList.add('hidden');
                    pauseButton.textContent = '‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢';
                    pauseOverlay.onclick = null;
                }
            }

            goHome() {
                this.cleanup();
                
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('buttonControls').classList.add('hidden');
                document.getElementById('homeScreen').classList.remove('hidden');
                
                loadBestRecords();
                showRanking('normal');
            }

            reset() {
                this.cleanup();
                this.initializeGameState();
                
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('actionDisplay').innerHTML = '';
                document.getElementById('timeDisplay').textContent = '';
                
                this.init();
                this.updateDisplay();
                this.updateModeInfo();
            }

            cleanup() {
                this.stopTimer();
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }
        }

        // ===========================================
        // TetrisAI - Ë¶≥Êà¶Áî®Ëá™Âãï„Éó„É¨„Ç§AI
        // ===========================================
        class TetrisAI {
            constructor(game) {
                this.game = game;
                
                // Ë©ï‰æ°Èñ¢Êï∞„ÅÆÈáç„ÅøÔºà„ÉÅ„É•„Éº„Éã„É≥„Ç∞ÂèØËÉΩÔºâ
                this.weights = {
                    height: -0.5,        // È´ò„Åï„Éö„Éä„É´„ÉÜ„Ç£
                    holes: -3.5,         // Á©¥„Éö„Éä„É´„ÉÜ„Ç£ÔºàÂº∑„ÇÅÔºâ
                    bumpiness: -0.2,     // ÂáπÂá∏„Éö„Éä„É´„ÉÜ„Ç£
                    linesCleared: 3.0,   // „É©„Ç§„É≥Ê∂àÂéª„Éú„Éº„Éä„Çπ
                    wellDepth: 0.1,      // ‰∫ïÊà∏Ôºà„ÉÜ„Éà„É™„ÇπÁî®„ÅÆÊ∫ùÔºâ„Éú„Éº„Éä„Çπ
                    multipleWells: -10.0 // Ë§áÊï∞‰∫ïÊà∏„Éö„Éä„É´„ÉÜ„Ç£ÔºàÂº∑„ÇÅÔºâ
                };
                
                // AIÂãï‰ΩúÁî®
                this.currentMove = null;
                this.moveQueue = [];
                this.thinkingComplete = false;
            }

            // „É°„Ç§„É≥: ÊúÄÂñÑÊâã„ÇíÊé¢Á¥¢
            findBestMove() {
                if (!this.game.currentPiece) {
                    return null;
                }

                const piece = this.game.currentPiece;
                let bestScore = -Infinity;
                let bestMove = null;

                // ÂÖ®ÂõûËª¢Áä∂ÊÖã„ÇíË©¶„ÅôÔºà0, 1, 2, 3ÂõûËª¢Ôºâ
                const rotations = this.getRotationCount(piece.type);
                
                for (let rotation = 0; rotation < rotations; rotation++) {
                    const rotatedPiece = this.getRotatedPiece(piece, rotation);
                    
                    // ÂÖ®x‰ΩçÁΩÆ„ÇíË©¶„Åô
                    const minX = -2;
                    const maxX = BOARD_WIDTH + 2;
                    
                    for (let x = minX; x < maxX; x++) {
                        const testPiece = this.clonePiece(rotatedPiece);
                        testPiece.position.x = x;
                        
                        // „Åì„ÅÆ‰ΩçÁΩÆ„ÅåÊúâÂäπ„ÅãÁ¢∫Ë™ç
                        if (this.isValidPosition(testPiece)) {
                            // „Éè„Éº„Éâ„Éâ„É≠„ÉÉ„Éó„Åó„Åü‰ΩçÁΩÆ„ÇíÂèñÂæó
                            const dropY = this.getDropPosition(testPiece);
                            testPiece.position.y = dropY;
                            
                            // „Åì„ÅÆÈÖçÁΩÆ„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                            const simulatedBoard = this.simulatePlacement(testPiece);
                            const score = this.evaluateBoard(simulatedBoard);
                            
                            if (score > bestScore) {
                                bestScore = score;
                                bestMove = {
                                    rotation: rotation,
                                    x: x,
                                    y: dropY
                                };
                            }
                        }
                    }
                }

                return bestMove;
            }

            // „Éî„Éº„Çπ„ÅÆÂõûËª¢Êï∞„ÇíÂèñÂæóÔºàO„ÅØ1„ÄÅI„ÅØ2„ÄÅ‰ªñ„ÅØ4Ôºâ
            getRotationCount(type) {
                if (type === 'O') return 1;
                if (type === 'I' || type === 'S' || type === 'Z') return 2;
                return 4;
            }

            // „Éî„Éº„Çπ„ÇíÊåáÂÆöÂõûÊï∞ÂõûËª¢
            getRotatedPiece(piece, rotations) {
                let rotated = this.clonePiece(piece);
                for (let i = 0; i < rotations; i++) {
                    rotated = rotated.rotate();
                }
                return rotated;
            }

            // „Éî„Éº„Çπ„Çí„ÇØ„É≠„Éº„É≥
            clonePiece(piece) {
                const cloned = new Tetromino(piece.type);
                cloned.shape = JSON.parse(JSON.stringify(piece.shape));
                cloned.position = { ...piece.position };
                return cloned;
            }

            // ‰ΩçÁΩÆ„ÅåÊúâÂäπ„ÅãÁ¢∫Ë™çÔºà„Ç≤„Éº„É†„ÅÆcheckCollision„Çí‰ΩøÁî®Ôºâ
            isValidPosition(piece) {
                return !this.checkCollisionForAI(piece, 0, 0);
            }

            // AIÁî®„ÅÆË°ùÁ™ÅÂà§ÂÆöÔºà„Ç≤„Éº„É†„ÅÆ„Éú„Éº„Éâ„ÇíÂèÇÁÖßÔºâ
            checkCollisionForAI(piece, offsetX, offsetY) {
                for (let i = 0; i < piece.shape.length; i++) {
                    for (let j = 0; j < piece.shape[i].length; j++) {
                        if (piece.shape[i][j] === 1) {
                            const x = piece.position.x + j + offsetX;
                            const y = piece.position.y + i + offsetY;
                            const boardY = y + BUFFER_HEIGHT;

                            if (x < 0 || x >= BOARD_WIDTH || boardY >= TOTAL_HEIGHT) {
                                return true;
                            }

                            if (boardY >= 0 && this.game.board[boardY] && this.game.board[boardY][x] !== null) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            // „Éè„Éº„Éâ„Éâ„É≠„ÉÉ„Éó„Åó„ÅüÊôÇ„ÅÆYÂ∫ßÊ®ô„ÇíÂèñÂæó
            getDropPosition(piece) {
                const testPiece = this.clonePiece(piece);
                while (!this.checkCollisionForAI(testPiece, 0, 1)) {
                    testPiece.position.y++;
                }
                return testPiece.position.y;
            }

            // ÈÖçÁΩÆ„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ôºà„Éú„Éº„Éâ„ÅÆ„Ç≥„Éî„Éº„ÇíËøî„ÅôÔºâ
            simulatePlacement(piece) {
                // „Éú„Éº„Éâ„Çí„Ç≥„Éî„Éº
                const boardCopy = this.game.board.map(row => [...row]);
                
                // „Éî„Éº„Çπ„ÇíÈÖçÁΩÆ
                for (let i = 0; i < piece.shape.length; i++) {
                    for (let j = 0; j < piece.shape[i].length; j++) {
                        if (piece.shape[i][j] === 1) {
                            const x = piece.position.x + j;
                            const y = piece.position.y + i;
                            const boardY = y + BUFFER_HEIGHT;
                            
                            if (boardY >= 0 && boardY < TOTAL_HEIGHT && x >= 0 && x < BOARD_WIDTH) {
                                boardCopy[boardY][x] = piece.color;
                            }
                        }
                    }
                }
                
                // „É©„Ç§„É≥Ê∂àÂéª„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                return this.simulateLineClear(boardCopy);
            }

            // „É©„Ç§„É≥Ê∂àÂéª„Çí„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
            simulateLineClear(board) {
                const newBoard = [];
                let linesCleared = 0;
                
                for (let y = 0; y < TOTAL_HEIGHT; y++) {
                    if (!board[y].every(cell => cell !== null)) {
                        newBoard.push(board[y]);
                    } else {
                        linesCleared++;
                    }
                }
                
                while (newBoard.length < TOTAL_HEIGHT) {
                    newBoard.unshift(Array(BOARD_WIDTH).fill(null));
                }
                
                newBoard.linesCleared = linesCleared;
                return newBoard;
            }

            // „Éú„Éº„Éâ„ÇíË©ï‰æ°
            evaluateBoard(board) {
                const linesCleared = board.linesCleared || 0;
                const heights = this.getColumnHeights(board);
                const aggregateHeight = heights.reduce((a, b) => a + b, 0);
                const holes = this.countHoles(board, heights);
                const bumpiness = this.calculateBumpiness(heights);
                const { wellDepth, wellCount } = this.calculateWellInfo(heights);
                
                // ‰∫ïÊà∏„Åå2ÂÄã‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Éö„Éä„É´„ÉÜ„Ç£
                const multipleWellsPenalty = wellCount >= 2 ? (wellCount - 1) : 0;

                return (
                    this.weights.height * aggregateHeight +
                    this.weights.holes * holes +
                    this.weights.bumpiness * bumpiness +
                    this.weights.linesCleared * linesCleared * linesCleared + // 4„É©„Ç§„É≥Ê∂à„Åó„ÇíÂÑ™ÈÅá
                    this.weights.wellDepth * wellDepth +
                    this.weights.multipleWells * multipleWellsPenalty
                );
            }

            // ÂêÑÂàó„ÅÆÈ´ò„Åï„ÇíÂèñÂæó
            getColumnHeights(board) {
                const heights = [];
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    let height = 0;
                    for (let y = 0; y < TOTAL_HEIGHT; y++) {
                        if (board[y][x] !== null) {
                            height = TOTAL_HEIGHT - y;
                            break;
                        }
                    }
                    heights.push(height);
                }
                return heights;
            }

            // Á©¥„ÅÆÊï∞„Çí„Ç´„Ç¶„É≥„Éà
            countHoles(board, heights) {
                let holes = 0;
                for (let x = 0; x < BOARD_WIDTH; x++) {
                    let blockFound = false;
                    for (let y = 0; y < TOTAL_HEIGHT; y++) {
                        if (board[y][x] !== null) {
                            blockFound = true;
                        } else if (blockFound) {
                            holes++;
                        }
                    }
                }
                return holes;
            }

            // ÂáπÂá∏Â∫¶„ÇíË®àÁÆó
            calculateBumpiness(heights) {
                let bumpiness = 0;
                for (let i = 0; i < heights.length - 1; i++) {
                    bumpiness += Math.abs(heights[i] - heights[i + 1]);
                }
                return bumpiness;
            }

            // ‰∫ïÊà∏„ÅÆÊÉÖÂ†±„ÇíË®àÁÆóÔºàÊ∑±„Åï„Å®ÂÄãÊï∞Ôºâ
            calculateWellInfo(heights) {
                let wellDepth = 0;
                let wellCount = 0;
                
                for (let i = 0; i < heights.length; i++) {
                    const leftHeight = i > 0 ? heights[i - 1] : Infinity;
                    const rightHeight = i < heights.length - 1 ? heights[i + 1] : Infinity;
                    const minNeighbor = Math.min(leftHeight, rightHeight);
                    
                    // ‰∫ïÊà∏„ÅÆÂà§ÂÆöÔºö‰∏°Èö£„Çà„Çä‰Ωé„ÅÑÂàó
                    if (heights[i] < minNeighbor) {
                        const depth = minNeighbor - heights[i];
                        wellDepth += depth;
                        
                        // Ê∑±„Åï2‰ª•‰∏ä„Çí‰∫ïÊà∏„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà
                        if (depth >= 2) {
                            wellCount++;
                        }
                    }
                }
                
                return { wellDepth, wellCount };
            }

            // ÊúÄÂñÑÊâã„Å∏„ÅÆ„É†„Éº„Éñ„Ç≠„É•„Éº„ÇíÁîüÊàê
            generateMoveQueue(targetMove) {
                if (!targetMove || !this.game.currentPiece) {
                    return [];
                }

                const moves = [];
                const currentPiece = this.game.currentPiece;

                // „Åæ„ÅöÂõûËª¢
                for (let i = 0; i < targetMove.rotation; i++) {
                    moves.push('rotate');
                }

                // Ê¨°„Å´Ê®™ÁßªÂãï
                const currentX = currentPiece.position.x;
                const targetX = targetMove.x;
                const deltaX = targetX - currentX;
                
                if (deltaX < 0) {
                    for (let i = 0; i < Math.abs(deltaX); i++) {
                        moves.push('left');
                    }
                } else if (deltaX > 0) {
                    for (let i = 0; i < deltaX; i++) {
                        moves.push('right');
                    }
                }

                // ÊúÄÂæå„Å´„Éè„Éº„Éâ„Éâ„É≠„ÉÉ„Éó
                moves.push('drop');

                return moves;
            }
        }

        // ===========================================
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®Èñ¢Êï∞
        // ===========================================
        let game = null;
        let controlMode = 'swipe';
        let isAIModeEnabled = false;  // AI„É¢„Éº„Éâ„ÅÆ„Ç∞„É≠„Éº„Éê„É´„Éï„É©„Ç∞
        
        function toggleAIMode() {
            isAIModeEnabled = document.getElementById('aiModeToggle').checked;
            const desc = document.getElementById('aiModeDesc');
            
            if (isAIModeEnabled) {
                desc.textContent = 'ON - AI„Åå„Éó„É¨„Ç§„Åó„Åæ„Åô';
                desc.classList.add('active');
            } else {
                desc.textContent = 'OFF - Ëá™ÂàÜ„Åß„Éó„É¨„Ç§';
                desc.classList.remove('active');
            }
        }
        
        function toggleInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.toggle('hidden');
        }
        
        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('infoModal');
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
        
        function setupGlobalControls() {
            // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
            document.addEventListener('keydown', (e) => {
                if (!game || game.isGameOver) {
                    return;
                }

                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        game.moveLeft();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        game.moveRight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        game.rotate();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (!game.isPaused) {
                            game.moveDown(true);
                        }
                        break;
                    case ' ':
                        e.preventDefault();
                        game.hardDrop();
                        break;
                    case 'p':
                    case 'P':
                        e.preventDefault();
                        game.togglePause();
                        break;
                }
            });

            // „Çø„ÉÉ„ÉÅÊìç‰Ωú
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            const minSwipeDistance = 30;
            const tapMaxDuration = 200;

            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('touchstart', (e) => {
                if (!game || game.isGameOver || game.isPaused) {
                    return;
                }
                
                e.preventDefault();
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
            });

            canvas.addEventListener('touchend', (e) => {
                if (!game || game.isGameOver || game.isPaused) {
                    return;
                }
                
                e.preventDefault();
                const touch = e.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                const touchDuration = Date.now() - touchStartTime;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);

                if (absDeltaX < minSwipeDistance && absDeltaY < minSwipeDistance && touchDuration < tapMaxDuration) {
                    game.rotate();
                    return;
                }

                if (absDeltaX > absDeltaY) {
                    if (deltaX < 0) {
                        game.moveLeft();
                    } else {
                        game.moveRight();
                    }
                } else {
                    if (deltaY < 0) {
                        game.hardDrop();
                    } else {
                        game.moveDown(true);
                    }
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });

            // UI„Éú„Çø„É≥
            document.getElementById('pauseButton').addEventListener('click', () => {
                if (game) {
                    game.togglePause();
                }
            });

            document.getElementById('restartButton').addEventListener('click', () => {
                if (game && confirm('„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    game.reset();
                }
            });

            document.getElementById('resetButton').addEventListener('click', () => {
                if (game && confirm('„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü')) {
                    game.goHome();
                }
            });

            document.getElementById('homeButton').addEventListener('click', () => {
                if (game) {
                    game.goHome();
                }
            });

            // „Éú„Çø„É≥Êìç‰ΩúÔºàtouchstart„ÅßÂç≥Â∫ß„Å´ÂèçÂøú„ÄÅclick„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            const gameButtons = [
                { id: 'leftBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveLeft() },
                { id: 'rightBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveRight() },
                { id: 'centerBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveDown(true) },
                { id: 'upBtn', action: () => game && !game.isPaused && !game.isGameOver && game.rotate() },
                { id: 'downBtn2', action: () => game && !game.isPaused && !game.isGameOver && game.hardDrop() }
            ];

            gameButtons.forEach(({ id, action }) => {
                const btn = document.getElementById(id);
                let touched = false;

                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touched = true;
                    action();
                }, { passive: false });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                }, { passive: false });

                // „Éû„Ç¶„ÇπÁî®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàPC„Åß„ÇÇÂãï‰ΩúÔºâ
                btn.addEventListener('click', (e) => {
                    if (!touched) {
                        action();
                    }
                    touched = false;
                });
            });
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            setupGlobalControls();
        });

        function toggleControlMode() {
            const isButton = document.getElementById('controlToggle').checked;
            const buttonControls = document.getElementById('buttonControls');
            const swipeInstructions = document.getElementById('swipeInstructions');
            
            if (isButton) {
                controlMode = 'button';
                buttonControls.classList.remove('hidden');
                swipeInstructions.classList.add('hidden');
            } else {
                controlMode = 'swipe';
                buttonControls.classList.add('hidden');
                swipeInstructions.classList.remove('hidden');
            }
        }

        function startGame(mode) {
            if (game) {
                game.cleanup();
                game = null;
            }
            
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('pauseOverlay').classList.add('hidden');
            
            // AI„É¢„Éº„Éâ„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„ÇíË°®Á§∫
            if (!isAIModeEnabled) {
                const isButton = document.getElementById('controlToggle').checked;
                if (isButton) {
                    document.getElementById('buttonControls').classList.remove('hidden');
                }
            } else {
                // AI„É¢„Éº„Éâ„Åß„ÅØ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                document.getElementById('buttonControls').classList.add('hidden');
            }
            
            // AI„É¢„Éº„Éâ„ÅØ„Ç∞„É≠„Éº„Éê„É´„Éï„É©„Ç∞„Åã„ÇâÂèñÂæó
            game = new TetrisGame(mode, isAIModeEnabled);
        }

        function loadBestRecords() {
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            
            if (records.normal && records.normal.length > 0) {
                document.getElementById('normalBest').textContent = `ÊúÄÈ´ò: ${records.normal[0].score.toLocaleString()} ÁÇπ`;
            }
            
            if (records.sprint1m && records.sprint1m.length > 0) {
                document.getElementById('sprint1mBest').textContent = `ÊúÄÈ´ò: ${records.sprint1m[0].lines} „É©„Ç§„É≥`;
            }
            
            ['time10', 'time20', 'time40', 'time100'].forEach(mode => {
                if (records[mode] && records[mode].length > 0) {
                    const time = records[mode][0].time;
                    const totalSeconds = time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                    document.getElementById(`${mode}Best`).textContent = `Ë®òÈå≤: ${timeStr}`;
                }
            });
        }

        // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫Áî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã
        let currentRankingMode = 'normal';
        let currentRankingType = 'human';  // 'human' or 'ai'

        function showRanking(mode, event) {
            currentRankingMode = mode;
            
            if (event && event.target) {
                document.querySelectorAll('.ranking-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            updateRankingList();
        }
        
        function toggleRankingType(type, event) {
            currentRankingType = type;
            
            if (event && event.target) {
                document.querySelectorAll('.ranking-subtab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            updateRankingList();
        }
        
        function updateRankingList() {
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            const rankingList = document.getElementById('rankingList');
            
            // AI„ÅÆÂ†¥Âêà„ÅØ„Ç≠„Éº„Å´„Çµ„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
            const recordKey = currentRankingType === 'ai' ? `${currentRankingMode}_ai` : currentRankingMode;
            
            if (!records[recordKey] || records[recordKey].length === 0) {
                const typeLabel = currentRankingType === 'ai' ? 'ü§ñ AI' : 'üë§ ‰∫∫Èñì';
                rankingList.innerHTML = `<div style="text-align:center; color:#888; padding:20px;">${typeLabel}„ÅÆË®òÈå≤„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
                return;
            }
            
            rankingList.innerHTML = records[recordKey].map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
                
                let displayValue = '';
                // recordKey„Åã„Çâ„Éô„Éº„Çπ„ÅÆmode„ÇíÂèñÂæó
                const baseMode = currentRankingMode;
                
                if (baseMode === 'normal') {
                    displayValue = `${record.score.toLocaleString()} ÁÇπ`;
                } else if (baseMode === 'sprint1m') {
                    displayValue = `${record.lines} „É©„Ç§„É≥`;
                } else {
                    const totalSeconds = record.time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    displayValue = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                }
                
                return `
                    <div class="ranking-item">
                        <span class="rank">#${index + 1}</span>
                        <span class="time">${displayValue}</span>
                        <span class="date">${dateStr}</span>
                    </div>
                `;
            }).join('');
        }

        function createStarField() {
            const container = document.getElementById('starsBackground');
            const starCount = 100;
            const lineCount = 15;
            const shootingStarCount = 3;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = 0.3 + Math.random() * 0.5;
                container.appendChild(star);
            }

            const stars = container.querySelectorAll('.star');
            for (let i = 0; i < lineCount; i++) {
                const star1 = stars[Math.floor(Math.random() * stars.length)];
                const star2 = stars[Math.floor(Math.random() * stars.length)];
                
                if (star1 !== star2) {
                    const x1 = parseFloat(star1.style.left);
                    const y1 = parseFloat(star1.style.top);
                    const x2 = parseFloat(star2.style.left);
                    const y2 = parseFloat(star2.style.top);
                    
                    const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    
                    if (distance < 20) {
                        const line = document.createElement('div');
                        line.className = 'constellation-line';
                        line.style.left = x1 + '%';
                        line.style.top = y1 + '%';
                        line.style.width = distance + '%';
                        
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        container.appendChild(line);
                    }
                }
            }

            for (let i = 0; i < shootingStarCount; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = Math.random() * 80 + '%';
                shootingStar.style.top = Math.random() * 50 + '%';
                shootingStar.style.animationDelay = Math.random() * 10 + 's';
                shootingStar.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(shootingStar);
            }
        }

        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨Èñã
        window.startGame = startGame;
        window.toggleControlMode = toggleControlMode;
        window.showRanking = showRanking;
        window.toggleRankingType = toggleRankingType;
        window.loadBestRecords = loadBestRecords;
        window.toggleAIMode = toggleAIMode;
        window.toggleInfoModal = toggleInfoModal;

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            loadBestRecords();
            showRanking('normal');
            createStarField();
        });
    </script>
</body>
</html>
