<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Å™„ÉÜ„Éà„É™„Çπ„Ç≤„Éº„É†">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>TETRIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iOS „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
        html {
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 90% 60%, rgba(255, 255, 255, 0.15), transparent),
                radial-gradient(1px 1px at 33% 85%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 75% 40%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(1px 1px at 15% 65%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(2px 2px at 45% 15%, rgba(255, 255, 255, 0.25), transparent),
                radial-gradient(1px 1px at 95% 85%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 25% 45%, rgba(255, 255, 255, 0.15), transparent),
                radial-gradient(2px 2px at 70% 90%, rgba(255, 255, 255, 0.25), transparent);
            background-size: 200% 200%;
            background-position: 0% 0%;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
            position: relative;
        }

        /* ÊòüÂ∫ßÈ¢®ËÉåÊôØ */
        .stars-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0.6;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .constellation-line {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, 
                rgba(100, 200, 255, 0) 0%, 
                rgba(100, 200, 255, 0.3) 50%, 
                rgba(100, 200, 255, 0) 100%);
            transform-origin: left center;
        }

        .shooting-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5);
            animation: shoot 3s linear infinite;
            opacity: 0;
        }

        @keyframes shoot {
            0% {
                opacity: 0;
                transform: translateX(0) translateY(0);
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                opacity: 0;
                transform: translateX(300px) translateY(300px);
            }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 40px;
            color: #00ffff;
            text-align: center;
            letter-spacing: 8px;
        }

        .action-display {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-text {
            font-size: 20px;
            font-weight: bold;
            color: #ffff00;
            background-color: rgba(128, 0, 128, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .game-area {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        #gameCanvas {
            border: 3px solid #475569;
            background-color: #1e293b;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 200px;
        }

        .panel-section {
            background-color: rgba(30, 41, 59, 0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .panel-section h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            text-align: center;
        }

        #nextCanvas {
            display: block;
            margin: 0 auto;
            background-color: rgba(128, 128, 128, 0.2);
            border-radius: 8px;
        }

        .score-display {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }

        .level-value {
            color: #ffff00;
        }

        .controls-info {
            font-size: 10px;
            line-height: 1.6;
            color: #ccc;
        }

        .controls-info h4 {
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            text-align: center;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .button-group button {
            flex: 1;
        }

        /* Êìç‰ΩúÂàá„ÇäÊõø„Åà„Éà„Ç∞„É´ */
        #controlTogglePanel {
            padding: 10px;
        }

        #controlTogglePanel h3 {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00ffff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-text {
            font-size: 12px;
            color: #aaa;
        }

        /* „Çπ„ÉØ„Ç§„ÉóÊìç‰ΩúË™¨Êòé */
        .swipe-instructions {
            margin-top: 10px;
            padding: 8px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 6px;
            font-size: 10px;
            color: #888;
            line-height: 1.6;
        }

        .swipe-instructions.hidden {
            display: none;
        }

        .swipe-title {
            color: #aaa;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 11px;
        }

        /* „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ */
        .button-controls {
            position: fixed;
            bottom: 20px;
            right: 30px;
            display: flex;
            justify-content: flex-end;
            z-index: 100;
            pointer-events: none;
        }

        .dpad-container {
            pointer-events: auto;
        }

        /* ÂçÅÂ≠ó„Ç≠„Éº */
        .dpad {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .dpad-row {
            display: flex;
            gap: 0;
        }

        .dpad-btn {
            width: 50px;
            height: 50px;
            background: rgba(58, 58, 58, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            color: rgba(255, 255, 255, 0.95);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .dpad-btn:active {
            background: rgba(80, 80, 80, 0.6);
            transform: scale(0.95);
        }

        .dpad-empty {
            width: 50px;
            height: 50px;
        }

        .dpad-center {
            width: 50px;
            height: 50px;
            background: rgba(26, 26, 26, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            border-radius: 50%;
        }

        .dpad-center-btn {
            width: 50px;
            height: 50px;
            background: rgba(26, 26, 26, 0.35);
            border: 2px solid rgba(120, 120, 120, 0.8);
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.95);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .dpad-center-btn:active {
            background: rgba(80, 80, 80, 0.6);
            transform: scale(0.95);
        }

        /* „Éç„Ç™„É≥ÂäπÊûú */
        .neon-glow {
            box-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 20px currentColor,
                inset 0 0 5px rgba(255, 255, 255, 0.2);
        }

        /* „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes lineFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes lineClear {
            0% { 
                transform: scaleX(1);
                opacity: 1;
            }
            50% {
                transform: scaleX(1.1);
                opacity: 0.5;
            }
            100% { 
                transform: scaleX(0);
                opacity: 0;
            }
        }

        button {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            /* iOSÈÄ£ÊâìÂØæÁ≠ñ */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .pause-button {
            background-color: #ffff00;
            color: #000;
        }

        .reset-button {
            background-color: #00ffff;
            color: #000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-content {
            background-color: #1e293b;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid;
        }

        .game-over-overlay {
            border-color: #ff0000;
        }

        .pause-overlay {
            border-color: #ffff00;
        }

        .overlay-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .game-over-title {
            color: #ff0000;
        }

        .pause-title {
            color: #ffff00;
        }

        .overlay-score {
            font-size: 20px;
            color: #fff;
            margin-bottom: 20px;
        }

        .overlay-button {
            background-color: #00ffff;
            color: #000;
            font-size: 18px;
            padding: 15px 30px;
        }

        .hidden {
            display: none;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .home-screen {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .home-title {
            font-size: 60px;
            color: #00ffff;
            letter-spacing: 12px;
            margin-bottom: 40px;
            text-shadow: 0 0 20px #00ffff;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .mode-button {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ffff;
            padding: 30px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-button:hover {
            transform: translateY(-5px);
            border-color: #ffff00;
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3);
        }

        .mode-button h2 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .mode-button p {
            color: #aaa;
            font-size: 14px;
            margin: 5px 0;
        }

        .mode-button .best-time {
            color: #ffff00;
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }

        .rankings {
            background: rgba(30, 41, 59, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .rankings h3 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .ranking-tab {
            background: rgba(128, 128, 128, 0.3);
            color: #aaa;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .ranking-tab.active {
            background: #00ffff;
            color: #000;
            border-color: #00ffff;
        }

        .ranking-list {
            text-align: left;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 6px;
            border-left: 3px solid #00ffff;
        }

        .ranking-item .rank {
            color: #ffff00;
            font-weight: bold;
            min-width: 40px;
        }

        .ranking-item .time {
            color: #00ffff;
            font-weight: bold;
        }

        .ranking-item .date {
            color: #888;
            font-size: 12px;
        }

        /* „Çø„Ç§„É†Ë°®Á§∫ */
        .time-display {
            font-size: 18px;
            color: #ffff00;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .mode-info {
            font-size: 14px;
            color: #00ffff;
            text-align: center;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .home-title {
                font-size: 40px;
                letter-spacing: 8px;
                margin-bottom: 30px;
            }

            .mode-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .mode-button {
                padding: 20px 15px;
            }

            .mode-button h2 {
                font-size: 20px;
            }

            .ranking-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .ranking-tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }

            .game-container {
                gap: 10px;
                width: 100%;
                max-height: 100vh;
                padding-bottom: 180px; /* „Éú„Çø„É≥Êìç‰Ωú„Çπ„Éö„Éº„ÇπÁ¢∫‰øù */
            }

            h1 {
                font-size: 24px;
                letter-spacing: 4px;
                margin-top: 5px;
            }

            .action-display {
                min-height: 30px;
            }

            .action-text {
                font-size: 14px;
                padding: 6px 12px;
            }

            .game-area {
                flex-direction: row;
                align-items: flex-start;
                width: 100%;
                gap: 8px;
                justify-content: center;
            }

            #gameCanvas {
                flex-shrink: 0;
            }

            .side-panel {
                width: auto;
                min-width: 100px;
                gap: 8px;
                flex-shrink: 1;
            }

            .panel-section {
                padding: 8px;
            }

            .panel-section h3 {
                font-size: 10px;
                margin-bottom: 4px;
            }

            #nextCanvas {
                width: 80px;
                height: 80px;
            }

            .score-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .score-value {
                font-size: 16px;
            }

            .button-group {
                gap: 6px;
            }

            button {
                font-size: 11px;
                padding: 8px 6px;
            }

            .overlay-content {
                padding: 20px;
                margin: 10px;
            }

            .overlay-title {
                font-size: 28px;
            }

            .overlay-score {
                font-size: 16px;
            }

            .overlay-button {
                font-size: 16px;
                padding: 12px 24px;
            }

            .dpad-btn {
                width: 70px;
                height: 70px;
                font-size: 20px;
            }

            .dpad-empty, .dpad-center, .dpad-center-btn {
                width: 70px;
                height: 70px;
            }

            .button-controls {
                right: 20px;
                bottom: 15px;
            }

            #controlTogglePanel {
                padding: 6px;
            }

            #controlTogglePanel h3 {
                font-size: 10px;
            }

            .toggle-text {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                letter-spacing: 2px;
            }

            .game-area {
                gap: 6px;
            }

            .side-panel {
                min-width: 90px;
                gap: 6px;
            }

            .panel-section {
                padding: 6px;
            }

            #nextCanvas {
                width: 70px;
                height: 70px;
            }

            .score-value {
                font-size: 14px;
            }

            button {
                font-size: 10px;
                padding: 6px 4px;
            }
        }

        @media (min-width: 769px) {
            .side-panel {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- ÊòüÂ∫ßÈ¢®ËÉåÊôØ -->
    <div class="stars-background" id="starsBackground"></div>

    <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
    <div id="homeScreen" class="home-screen">
        <h1 class="home-title">TETRIS</h1>
        
        <div class="mode-selection">
            <div class="mode-button" onclick="startGame('normal')">
                <h2>„Éé„Éº„Éû„É´</h2>
                <p>„Ç®„É≥„Éâ„É¨„Çπ„É¢„Éº„Éâ</p>
                <p>„Çπ„Ç≥„Ç¢„Ç¢„Çø„ÉÉ„ÇØ</p>
                <div class="best-time" id="normalBest">ÊúÄÈ´ò: - ÁÇπ</div>
            </div>
            
            <div class="mode-button" onclick="startGame('sprint1m')">
                <h2>1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà</h2>
                <p>60Áßí„ÉÅ„É£„É¨„É≥„Ç∏</p>
                <p>„É©„Ç§„É≥Êï∞„ÇíÁ´∂„ÅÜ</p>
                <div class="best-time" id="sprint1mBest">ÊúÄÈ´ò: - „É©„Ç§„É≥</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time10')">
                <h2>10„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>10„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time10Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time20')">
                <h2>20„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>20„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time20Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time50')">
                <h2>50„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>50„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time50Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time100')">
                <h2>100„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>100„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time100Best">Ë®òÈå≤: --:--.---</div>
            </div>
        </div>

        <div class="rankings">
            <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
            <div class="ranking-tabs">
                <button class="ranking-tab active" onclick="showRanking('normal', event)">„Éé„Éº„Éû„É´</button>
                <button class="ranking-tab" onclick="showRanking('sprint1m', event)">1ÂàÜÈñì</button>
                <button class="ranking-tab" onclick="showRanking('time10', event)">10„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time20', event)">20„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time50', event)">50„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time100', event)">100„É©„Ç§„É≥</button>
            </div>
            <div class="ranking-list" id="rankingList"></div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div class="game-container hidden" id="gameScreen">
        <h1>TETRIS</h1>
        
        <div class="mode-info" id="modeInfo"></div>
        <div class="time-display" id="timeDisplay"></div>
        <div class="action-display" id="actionDisplay"></div>

        <div class="game-area">
            <canvas id="gameCanvas"></canvas>

            <div class="side-panel">
                <div class="panel-section">
                    <h3>NEXT</h3>
                    <canvas id="nextCanvas" width="120" height="120"></canvas>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„Çπ„Ç≥„Ç¢</div>
                    <div class="score-value" id="scoreDisplay">0</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É¨„Éô„É´</div>
                    <div class="score-value level-value" id="levelDisplay">1</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É©„Ç§„É≥</div>
                    <div class="score-value level-value" id="linesDisplay">0</div>
                </div>

                <div class="panel-section" id="controlTogglePanel">
                    <h3>Êìç‰ΩúÊñπÊ≥ï</h3>
                    <div class="toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" id="controlToggle" onchange="toggleControlMode()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-text">„Éú„Çø„É≥</span>
                    </div>
                    <div class="swipe-instructions" id="swipeInstructions">
                        <div class="swipe-title">„Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú</div>
                        <div>„Çø„ÉÉ„Éó: ÂõûËª¢</div>
                        <div>‚Üê ‚Üí: ÁßªÂãï</div>
                        <div>‚Üë: ‰∏ÄÊ∞ó„Å´ËêΩ‰∏ã</div>
                        <div>‚Üì: È´òÈÄüËêΩ‰∏ã</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="pause-button" id="pauseButton">‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="reset-button" id="restartButton" style="display:none;">üîÑ „É™„Çπ„Çø„Éº„Éà</button>
                    <button class="reset-button" id="resetButton">üè† „Éõ„Éº„É†</button>
                </div>
            </div>
        </div>

        <!-- „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ -->
        <div id="buttonControls" class="button-controls hidden">
            <div class="dpad-container">
                <!-- ÂçÅÂ≠ó„Ç≠„Éº -->
                <div class="dpad">
                    <div class="dpad-row">
                        <div class="dpad-empty"></div>
                        <button class="dpad-btn" id="upBtn">üîÑ<br><span style="font-size:10px;">ÂõûËª¢</span></button>
                        <div class="dpad-empty"></div>
                    </div>
                    <div class="dpad-row">
                        <button class="dpad-btn" id="leftBtn">‚óÄ</button>
                        <button class="dpad-center-btn" id="centerBtn">‚¨áÔ∏è</button>
                        <button class="dpad-btn" id="rightBtn">‚ñ∂</button>
                    </div>
                    <div class="dpad-row">
                        <div class="dpad-empty"></div>
                        <button class="dpad-btn" id="downBtn2">‚¨áÔ∏è<br><span style="font-size:10px;">ËêΩ‰∏ã</span></button>
                        <div class="dpad-empty"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameOverOverlay" class="overlay hidden">
        <div class="overlay-content game-over-overlay">
            <div class="overlay-title game-over-title">GAME OVER</div>
            <div class="overlay-score">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore">0</span></div>
            <button class="overlay-button" id="homeButton">üè† „Éõ„Éº„É†„Å´Êàª„Çã</button>
        </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
        <div class="overlay-content pause-overlay">
            <div class="overlay-title pause-title">‰∏ÄÊôÇÂÅúÊ≠¢</div>
            <div class="overlay-score">„Çø„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÈñã</div>
            <button class="overlay-button" onclick="game.togglePause()">‚ñ∂ ÂÜçÈñã</button>
        </div>
    </div>

    <script>
        // ===========================================
        // ÂÆöÊï∞ÂÆöÁæ©
        // ===========================================
        const TETROMINO_TYPES = {
            I: { shape: [[1, 1, 1, 1]], color: '#00ffff' },
            O: { shape: [[1, 1], [1, 1]], color: '#ffff00' },
            T: { shape: [[0, 1, 0], [1, 1, 1]], color: '#800080' },
            S: { shape: [[0, 1, 1], [1, 1, 0]], color: '#00ff00' },
            Z: { shape: [[1, 1, 0], [0, 1, 1]], color: '#ff0000' },
            J: { shape: [[1, 0, 0], [1, 1, 1]], color: '#0000ff' },
            L: { shape: [[0, 0, 1], [1, 1, 1]], color: '#ff8800' }
        };

        const GAME_STATES = {
            PLAYING: 'PLAYING',
            LINE_CLEARING: 'LINE_CLEARING',
            GAME_OVER: 'GAME_OVER',
            PAUSED: 'PAUSED'
        };

        // ===========================================
        // „Éú„Éº„ÉâË®≠ÂÆö„Å®Â∫ßÊ®ôÁ≥ª
        // ===========================================
        // 
        // „ÄêÂ∫ßÊ®ôÁ≥ª„ÅÆË™¨Êòé„Äë
        // - „Éî„Éº„ÇπÂ∫ßÊ®ô(y): -2„Äú19 „ÅÆÁØÑÂõ≤„ÅßÂãï‰Ωú
        //   - y < 0: „Éê„ÉÉ„Éï„Ç°È†òÂüüÔºàÁîªÈù¢Â§ñ„ÉªÈùûË°®Á§∫Ôºâ
        //   - y >= 0: Ë°®Á§∫È†òÂüüÔºàÁîªÈù¢ÂÜÖÔºâ
        //
        // - „Éú„Éº„ÉâÈÖçÂàó„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ(boardY): 0„Äú21
        //   - boardY = y + BUFFER_HEIGHT
        //   - boardY 0„Äú1: „Éê„ÉÉ„Éï„Ç°ÔºàÈùûË°®Á§∫Ôºâ
        //   - boardY 2„Äú21: Ë°®Á§∫È†òÂüü
        //
        // „Äê„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÊù°‰ª∂„Äë
        // - „Éñ„É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: Êñ∞„Éî„Éº„Çπ„Åå„Çπ„Éù„Éº„É≥ÊôÇ„Å´Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å®Ë°ùÁ™Å
        // - „É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: „Éî„Éº„Çπ„Åå„Éê„ÉÉ„Éï„Ç°ÂÜÖÔºàboardY < 2Ôºâ„Å´Âõ∫ÂÆö„Åï„Çå„Åü
        //
        const BOARD_WIDTH = 10;
        const BOARD_HEIGHT = 20;        // Ë°®Á§∫È†òÂüü„ÅÆÈ´ò„Åï
        const BUFFER_HEIGHT = 2;        // ‰∏ä„Éê„ÉÉ„Éï„Ç°„ÅÆÈ´ò„ÅïÔºàÊú¨ÂÆ∂„ÉÜ„Éà„É™„Çπ‰ªïÊßòÔºâ
        const TOTAL_HEIGHT = BOARD_HEIGHT + BUFFER_HEIGHT;  // „Éú„Éº„ÉâÈÖçÂàó„ÅÆÁ∑èÈ´ò„ÅïÔºà22Ôºâ
        const LINE_CLEAR_FRAMES = 12;
        const SPRINT_DURATION_MS = 60000;

        // ===========================================
        // Tetromino„ÇØ„É©„Çπ
        // ===========================================
        class Tetromino {
            constructor(type) {
                this.type = type;
                this.shape = JSON.parse(JSON.stringify(TETROMINO_TYPES[type].shape));
                this.color = TETROMINO_TYPES[type].color;
                // „Çπ„Éù„Éº„É≥‰ΩçÁΩÆ: y=-1Ôºà„Éê„ÉÉ„Éï„Ç°ÂÜÖÔºâ„Åã„ÇâÈñãÂßã
                // „Éî„Éº„Çπ„ÅÆ‰∏ãÈÉ®„ÅåÁîªÈù¢‰∏äÁ´Ø(y=0)‰ªòËøë„Å´Áèæ„Çå„Çã
                this.position = { x: 3, y: -1 };
            }

            rotate() {
                const rows = this.shape.length;
                const cols = this.shape[0].length;
                const newShape = [];

                for (let j = 0; j < cols; j++) {
                    const newRow = [];
                    for (let i = rows - 1; i >= 0; i--) {
                        newRow.push(this.shape[i][j]);
                    }
                    newShape.push(newRow);
                }

                const rotated = new Tetromino(this.type);
                rotated.shape = newShape;
                rotated.position = { ...this.position };
                return rotated;
            }

            clone() {
                const cloned = new Tetromino(this.type);
                cloned.shape = JSON.parse(JSON.stringify(this.shape));
                cloned.position = { ...this.position };
                return cloned;
            }
        }

        // ===========================================
        // TetrisGame„ÇØ„É©„Çπ
        // ===========================================
        class TetrisGame {
            constructor(mode = 'normal') {
                this.mode = mode;
                this.blockSize = this.calculateBlockSize();
                
                // „Ç≠„É£„É≥„Éê„ÇπÂàùÊúüÂåñ
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = BOARD_WIDTH * this.blockSize;
                this.canvas.height = BOARD_HEIGHT * this.blockSize;

                this.nextCanvas = document.getElementById('nextCanvas');
                this.nextCtx = this.nextCanvas.getContext('2d');

                // „Ç≤„Éº„É†Áä∂ÊÖãÂàùÊúüÂåñ
                this.initializeGameState();
                
                // „Ç≤„Éº„É†ÈñãÂßã
                this.init();
                this.updateModeInfo();
            }

            initializeGameState() {
                this.board = [];
                this.currentPiece = null;
                this.nextPieceType = null;
                this.pieceBag = [];
                
                this.score = 0;
                this.level = 1;
                this.linesCleared = 0;
                
                this.gameState = GAME_STATES.PLAYING;
                this.isGameOver = false;
                this.isPaused = false;
                
                this.lastMoveWasRotation = false;
                this.lastAction = '';
                
                // „Çø„Ç§„Éû„ÉºÈñ¢ÈÄ£
                this.startTime = null;
                this.elapsedTime = 0;
                this.timerInterval = null;
                this.timerStarted = false;
                
                // „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà
                this.lineClearData = null;
                this.flashingLines = [];
                this.flashCounter = 0;
                
                // „Ç≤„Éº„É†„É´„Éº„Éó
                this.lastUpdateTime = 0;
                this.dropTimer = 0;
                this.animationFrameId = null;
                
                // ÁõÆÊ®ô„É©„Ç§„É≥Êï∞
                this.targetLines = this.getTargetLines();
            }

            getTargetLines() {
                const targets = {
                    'time10': 10,
                    'time20': 20,
                    'time50': 50,
                    'time100': 100,
                    'sprint1m': Infinity
                };
                return targets[this.mode] || null;
            }

            calculateBlockSize() {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    const availableWidth = window.innerWidth - 120;
                    const blockSize = Math.floor(availableWidth / BOARD_WIDTH);
                    return Math.min(Math.max(blockSize, 20), 30);
                }
                return 25;
            }

            updateModeInfo() {
                const modeInfo = document.getElementById('modeInfo');
                const restartButton = document.getElementById('restartButton');
                
                const modeTexts = {
                    'normal': 'üìä „Éé„Éº„Éû„É´„É¢„Éº„Éâ',
                    'sprint1m': '‚ö° 1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà',
                    'time10': '‚è±Ô∏è 10„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time20': '‚è±Ô∏è 20„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time50': '‚è±Ô∏è 50„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ',
                    'time100': '‚è±Ô∏è 100„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ'
                };
                
                modeInfo.textContent = modeTexts[this.mode] || '';
                restartButton.style.display = this.mode === 'normal' ? 'none' : 'block';
            }

            // ===========================================
            // ÂàùÊúüÂåñ
            // ===========================================
            init() {
                // „Éú„Éº„ÉâÈÖçÂàó: 22Ë°åÔºà‰∏ä2Ë°å„Éê„ÉÉ„Éï„Ç° + Ë°®Á§∫20Ë°åÔºâ
                this.board = Array(TOTAL_HEIGHT).fill(null).map(() => 
                    Array(BOARD_WIDTH).fill(null)
                );

                this.fillPieceBag();
                this.nextPieceType = this.getNextPieceFromBag();
                this.spawnNewPiece();
                this.drawNext();
                
                this.lastUpdateTime = performance.now();
                this.startGameLoop();
            }

            fillPieceBag() {
                const types = Object.keys(TETROMINO_TYPES);
                this.pieceBag = [...types];
                // Fisher-Yates„Ç∑„É£„ÉÉ„Éï„É´
                for (let i = this.pieceBag.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.pieceBag[i], this.pieceBag[j]] = [this.pieceBag[j], this.pieceBag[i]];
                }
            }

            getNextPieceFromBag() {
                if (this.pieceBag.length === 0) {
                    this.fillPieceBag();
                }
                return this.pieceBag.shift();
            }

            // ===========================================
            // „Çø„Ç§„Éû„ÉºÁÆ°ÁêÜ
            // ===========================================
            startTimer() {
                if (this.timerInterval !== null) {
                    return;
                }
                
                this.startTime = Date.now();
                this.timerStarted = true;
                
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused && !this.isGameOver) {
                        this.elapsedTime = Date.now() - this.startTime;
                        this.updateTimeDisplay();
                        
                        // 1ÂàÜÈñì„Çπ„Éó„É™„É≥„Éà: ÊôÇÈñìÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
                        if (this.mode === 'sprint1m' && this.elapsedTime >= SPRINT_DURATION_MS) {
                            this.endSprintMode();
                        }
                    }
                }, 10);
            }
            
            stopTimer() {
                if (this.timerInterval !== null) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            updateTimeDisplay() {
                const timeDisplay = document.getElementById('timeDisplay');
                const totalSeconds = this.elapsedTime / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds % 1) * 1000);
                
                if (this.mode === 'normal') {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
                }
            }

            // ===========================================
            // „Ç≤„Éº„É†„É´„Éº„Éó
            // ===========================================
            startGameLoop() {
                const gameLoop = (currentTime) => {
                    if (this.isGameOver) {
                        return;
                    }

                    const deltaTime = currentTime - this.lastUpdateTime;
                    this.lastUpdateTime = currentTime;

                    if (!this.isPaused) {
                        this.update(deltaTime);
                    }

                    this.draw();
                    this.animationFrameId = requestAnimationFrame(gameLoop);
                };

                this.animationFrameId = requestAnimationFrame(gameLoop);
            }

            update(deltaTime) {
                // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´„Çø„Ç§„Éû„Éº„Çπ„Çø„Éº„Éà
                if (!this.timerStarted && this.currentPiece !== null) {
                    this.startTimer();
                }
                
                // „É©„Ç§„É≥Ê∂àÂéª‰∏≠„ÅÆÂá¶ÁêÜ
                if (this.gameState === GAME_STATES.LINE_CLEARING) {
                    if (this.lineClearData !== null) {
                        this.lineClearData.frameCount++;
                        if (this.lineClearData.frameCount >= LINE_CLEAR_FRAMES) {
                            this.completeClearLines();
                        }
                    }
                    return;
                }
                
                // ÈÄöÂ∏∏„Éó„É¨„Ç§‰∏≠„ÅÆËêΩ‰∏ãÂá¶ÁêÜ
                if (this.gameState === GAME_STATES.PLAYING && this.currentPiece !== null) {
                    const dropInterval = Math.max(200, 700 - (this.level - 1) * 50);
                    this.dropTimer += deltaTime;
                    
                    if (this.dropTimer >= dropInterval) {
                        this.dropTimer = 0;
                        this.moveDown(false);
                    }
                }
            }

            // ===========================================
            // „Éî„Éº„ÇπÊìç‰Ωú
            // ===========================================
            spawnNewPiece() {
                if (this.isGameOver) {
                    return;
                }

                const newPiece = new Tetromino(this.nextPieceType);
                this.nextPieceType = this.getNextPieceFromBag();
                this.drawNext();

                if (this.checkCollision(newPiece, 0, 0)) {
                    this.triggerGameOver();
                } else {
                    this.currentPiece = newPiece;
                    this.gameState = GAME_STATES.PLAYING;
                }
            }

            checkCollision(piece, offsetX, offsetY) {
                if (!piece || !piece.shape) {
                    return true;
                }
                
                for (let i = 0; i < piece.shape.length; i++) {
                    for (let j = 0; j < piece.shape[i].length; j++) {
                        if (piece.shape[i][j] === 1) {
                            const x = piece.position.x + j + offsetX;
                            const y = piece.position.y + i + offsetY;
                            const boardY = y + BUFFER_HEIGHT;

                            // Â∑¶Âè≥„ÅÆÂ£Å„ÉªÂ∫ï„Å®„ÅÆË°ùÁ™Å
                            if (x < 0 || x >= BOARD_WIDTH || boardY >= TOTAL_HEIGHT) {
                                return true;
                            }

                            // „Éê„ÉÉ„Éï„Ç°„Çà„Çä‰∏ä„ÅØË°ùÁ™Å„Å™„ÅóÔºà„Çπ„Éù„Éº„É≥ÊôÇ„ÅÆ„ÅøÁô∫ÁîüÔºâ
                            if (boardY < 0) {
                                continue;
                            }

                            // Êó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„Å®„ÅÆË°ùÁ™Å
                            if (this.board[boardY] && this.board[boardY][x] !== null) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }

            moveDown(manual = false) {
                if (!this.currentPiece || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                    if (manual) {
                        this.lastMoveWasRotation = false;
                    }
                } else {
                    this.lockPiece();
                }
            }

            moveLeft() {
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, -1, 0)) {
                    this.currentPiece.position.x--;
                    this.lastMoveWasRotation = false;
                }
            }

            moveRight() {
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                if (!this.checkCollision(this.currentPiece, 1, 0)) {
                    this.currentPiece.position.x++;
                    this.lastMoveWasRotation = false;
                }
            }

            rotate() {
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                const rotated = this.currentPiece.rotate();
                
                if (!this.checkCollision(rotated, 0, 0)) {
                    this.currentPiece = rotated;
                    this.lastMoveWasRotation = true;
                    return;
                }

                // Super Rotation System (SRS) - Â£Å„Ç≠„ÉÉ„ÇØ
                const kickTests = [[-1, 0], [1, 0], [0, -1], [-1, -1], [1, -1]];

                for (const [kickX, kickY] of kickTests) {
                    const kicked = rotated.clone();
                    kicked.position.x += kickX;
                    kicked.position.y += kickY;

                    if (!this.checkCollision(kicked, 0, 0)) {
                        this.currentPiece = kicked;
                        this.lastMoveWasRotation = true;
                        return;
                    }
                }
            }

            hardDrop() {
                if (!this.currentPiece || this.isPaused || this.isGameOver || this.gameState !== GAME_STATES.PLAYING) {
                    return;
                }

                while (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                }
                this.lastMoveWasRotation = false;
                this.lockPiece();
            }

            // ===========================================
            // „Éî„Éº„ÇπÂõ∫ÂÆö„Å®„É©„Ç§„É≥Ê∂àÂéª
            // ===========================================
            lockPiece() {
                if (!this.currentPiece) {
                    return;
                }

                const isTSpin = this.checkTSpin(this.currentPiece);
                let lockedInBuffer = false;

                // „Éú„Éº„Éâ„Å´„Éî„Éº„Çπ„ÇíÂõ∫ÂÆö
                for (let i = 0; i < this.currentPiece.shape.length; i++) {
                    for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                        if (this.currentPiece.shape[i][j] === 1) {
                            const x = this.currentPiece.position.x + j;
                            const y = this.currentPiece.position.y + i;
                            const boardY = y + BUFFER_HEIGHT;
                            
                            if (boardY >= 0 && boardY < TOTAL_HEIGHT && x >= 0 && x < BOARD_WIDTH) {
                                this.board[boardY][x] = this.currentPiece.color;
                                
                                // „Éê„ÉÉ„Éï„Ç°ÂÜÖ„Å´Âõ∫ÂÆö„Åï„Çå„Åü„ÅãÂà§ÂÆöÔºà„É≠„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÊù°‰ª∂Ôºâ
                                if (boardY < BUFFER_HEIGHT) {
                                    lockedInBuffer = true;
                                }
                            }
                        }
                    }
                }

                this.currentPiece = null;
                this.lastMoveWasRotation = false;

                // „É≠„ÉÉ„ÇØ„Ç¢„Ç¶„Éà: „Éê„ÉÉ„Éï„Ç°ÂÜÖ„Å´„Éñ„É≠„ÉÉ„ÇØ„ÅåÊÆã„Å£„ÅüÂ†¥Âêà„ÅØ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                if (lockedInBuffer) {
                    this.triggerGameOver();
                    return;
                }

                this.processLineClear(isTSpin);
            }

            checkTSpin(piece) {
                if (piece.type !== 'T' || !this.lastMoveWasRotation) {
                    return false;
                }

                const x = piece.position.x;
                const y = piece.position.y;
                const corners = [[x, y], [x + 2, y], [x, y + 2], [x + 2, y + 2]];
                let filledCorners = 0;

                for (const [cx, cy] of corners) {
                    const boardY = cy + BUFFER_HEIGHT;
                    
                    // Â£Å„ÉªÁØÑÂõ≤Â§ñ„ÉªÊó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„ÅØfilled„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà
                    if (cx < 0 || cx >= BOARD_WIDTH || boardY < 0 || boardY >= TOTAL_HEIGHT) {
                        filledCorners++;
                    } else if (this.board[boardY] && this.board[boardY][cx] !== null) {
                        filledCorners++;
                    }
                }

                return filledCorners >= 3;
            }

            processLineClear(isTSpin) {
                const linesToClear = [];

                // Ë°®Á§∫È†òÂüü„ÅÆ„Åø„É©„Ç§„É≥„ÇØ„É™„Ç¢Âà§ÂÆöÔºà„Éê„ÉÉ„Éï„Ç°„ÅØÂØæË±°Â§ñÔºâ
                for (let boardY = BUFFER_HEIGHT; boardY < TOTAL_HEIGHT; boardY++) {
                    if (this.board[boardY].every(cell => cell !== null)) {
                        linesToClear.push(boardY);
                    }
                }

                if (linesToClear.length > 0) {
                    this.gameState = GAME_STATES.LINE_CLEARING;
                    this.lineClearData = {
                        lines: linesToClear,
                        isTSpin: isTSpin,
                        count: linesToClear.length,
                        frameCount: 0
                    };
                    this.flashingLines = linesToClear;
                    this.flashCounter = 0;
                } else {
                    this.spawnNewPiece();
                }
            }
            
            completeClearLines() {
                const data = this.lineClearData;
                if (!data) {
                    this.gameState = GAME_STATES.PLAYING;
                    this.spawnNewPiece();
                    return;
                }

                // Ê∂àÂéªÂØæË±°‰ª•Â§ñ„ÅÆ„É©„Ç§„É≥„Çí‰øùÊåÅ
                const newBoard = [];
                for (let boardY = 0; boardY < TOTAL_HEIGHT; boardY++) {
                    if (!data.lines.includes(boardY)) {
                        newBoard.push(this.board[boardY]);
                    }
                }

                // ‰∏äÈÉ®„Å´Á©∫„ÅÆ„É©„Ç§„É≥„ÇíËøΩÂä†
                while (newBoard.length < TOTAL_HEIGHT) {
                    newBoard.unshift(Array(BOARD_WIDTH).fill(null));
                }

                this.board = newBoard;

                // „Çπ„Ç≥„Ç¢Ë®àÁÆó
                const scoreTable = { 1: 25, 2: 100, 3: 400, 4: 1600 };
                const lineScore = scoreTable[data.count] || 25;
                this.score += lineScore * (this.level + 1);
                
                // T„Çπ„Éî„É≥„Éú„Éº„Éä„Çπ
                if (data.isTSpin && data.count > 0) {
                    const bonus = data.count * 400 * this.level;
                    this.score += bonus;
                    const spinTypes = { 1: 'SINGLE', 2: 'DOUBLE', 3: 'TRIPLE' };
                    this.showAction(`T-SPIN ${spinTypes[data.count] || ''}! +${bonus}`);
                } else if (data.count === 4) {
                    const bonus = 800 * this.level;
                    this.score += bonus;
                    this.showAction(`TETRIS! +${bonus}`);
                }

                this.linesCleared += data.count;

                // „É¨„Éô„É´„Ç¢„ÉÉ„Éó
                const newLevel = Math.floor(this.linesCleared / 10) + 1;
                if (newLevel > this.level) {
                    this.level = newLevel;
                }

                this.updateDisplay();

                // „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.targetLines !== null && this.targetLines !== Infinity && this.linesCleared >= this.targetLines) {
                    this.completeTimeAttack();
                    return;
                }

                // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà„Åó„Å¶Ê¨°„ÅÆ„Éî„Éº„Çπ„ÇíÁîüÊàê
                this.flashingLines = [];
                this.flashCounter = 0;
                this.lineClearData = null;
                this.gameState = GAME_STATES.PLAYING;
                this.spawnNewPiece();
            }

            // ===========================================
            // „Ç≤„Éº„É†ÁµÇ‰∫ÜÂá¶ÁêÜ
            // ===========================================
            triggerGameOver() {
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                if (this.mode === 'normal') {
                    this.saveRecord();
                }
                this.showGameOver();
            }

            endSprintMode() {
                if (this.isGameOver) {
                    return;
                }
                
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                this.saveRecord();
                this.showSprintComplete();
            }

            completeTimeAttack() {
                this.isGameOver = true;
                this.gameState = GAME_STATES.GAME_OVER;
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.stopTimer();
                
                this.saveRecord();
                this.showTimeAttackComplete();
            }

            saveRecord() {
                const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
                if (!records[this.mode]) {
                    records[this.mode] = [];
                }

                const record = {
                    mode: this.mode,
                    date: new Date().toISOString()
                };

                if (this.mode === 'normal') {
                    record.score = this.score;
                } else if (this.mode === 'sprint1m') {
                    record.lines = this.linesCleared;
                } else {
                    record.time = this.elapsedTime;
                }

                records[this.mode].push(record);
                records[this.mode].sort((a, b) => {
                    if (this.mode === 'normal') {
                        return b.score - a.score;
                    } else if (this.mode === 'sprint1m') {
                        return b.lines - a.lines;
                    }
                    return a.time - b.time;
                });
                records[this.mode] = records[this.mode].slice(0, 10);

                localStorage.setItem('tetrisRecords', JSON.stringify(records));
            }

            showGameOver() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'GAME OVER';
                title.style.color = '#ff0000';
                
                document.getElementById('finalScore').textContent = this.score.toLocaleString() + ' ÁÇπ';
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            showSprintComplete() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'ÊôÇÈñìÂàá„Çå!';
                title.style.color = '#00ff00';
                
                document.getElementById('finalScore').textContent = `${this.linesCleared} „É©„Ç§„É≥`;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            showTimeAttackComplete() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'COMPLETE!';
                title.style.color = '#00ff00';
                
                const timeStr = this.formatTime(this.elapsedTime);
                document.getElementById('finalScore').textContent = timeStr;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            formatTime(milliseconds) {
                const totalSeconds = milliseconds / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const ms = Math.floor((totalSeconds % 1) * 1000);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }

            // ===========================================
            // ÊèèÁîª
            // ===========================================
            draw() {
                this.ctx.fillStyle = '#1e293b';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Âõ∫ÂÆö„Éñ„É≠„ÉÉ„ÇØ„ÅÆÊèèÁîªÔºàË°®Á§∫È†òÂüü„ÅÆ„ÅøÔºâ
                for (let screenY = 0; screenY < BOARD_HEIGHT; screenY++) {
                    const boardY = screenY + BUFFER_HEIGHT;
                    for (let x = 0; x < BOARD_WIDTH; x++) {
                        if (this.board[boardY] && this.board[boardY][x]) {
                            // „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà
                            if (this.gameState === GAME_STATES.LINE_CLEARING && 
                                this.flashingLines.includes(boardY) && 
                                this.flashCounter < 6) {
                                this.ctx.fillStyle = '#ffffff';
                                this.ctx.shadowBlur = 15;
                                this.ctx.shadowColor = '#ffffff';
                                this.ctx.fillRect(
                                    x * this.blockSize,
                                    screenY * this.blockSize,
                                    this.blockSize,
                                    this.blockSize
                                );
                                this.ctx.shadowBlur = 0;
                            } else {
                                this.drawBlock(x, screenY, this.board[boardY][x]);
                            }
                        } else {
                            this.drawEmptyBlock(x, screenY);
                        }
                    }
                }
                
                if (this.gameState === GAME_STATES.LINE_CLEARING) {
                    this.flashCounter++;
                }

                // „Ç¥„Éº„Çπ„Éà„Å®„Ç´„É¨„É≥„Éà„Éî„Éº„Çπ„ÅÆÊèèÁîª
                if (this.currentPiece) {
                    // „Ç¥„Éº„Çπ„ÉàÔºàËêΩ‰∏ã‰ΩçÁΩÆ„Éó„É¨„Éì„É•„ÉºÔºâ
                    const ghost = this.getGhostPosition();
                    if (ghost) {
                        for (let i = 0; i < ghost.shape.length; i++) {
                            for (let j = 0; j < ghost.shape[i].length; j++) {
                                if (ghost.shape[i][j] === 1) {
                                    const x = ghost.position.x + j;
                                    const y = ghost.position.y + i;
                                    if (y >= 0) {
                                        this.ctx.fillStyle = this.currentPiece.color + '40';
                                        this.ctx.fillRect(
                                            x * this.blockSize,
                                            y * this.blockSize,
                                            this.blockSize,
                                            this.blockSize
                                        );
                                        this.ctx.strokeStyle = this.currentPiece.color + 'AA';
                                        this.ctx.lineWidth = 2;
                                        this.ctx.strokeRect(
                                            x * this.blockSize,
                                            y * this.blockSize,
                                            this.blockSize,
                                            this.blockSize
                                        );
                                    }
                                }
                            }
                        }
                    }

                    // „Ç´„É¨„É≥„Éà„Éî„Éº„Çπ
                    for (let i = 0; i < this.currentPiece.shape.length; i++) {
                        for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                            if (this.currentPiece.shape[i][j] === 1) {
                                const x = this.currentPiece.position.x + j;
                                const y = this.currentPiece.position.y + i;
                                if (y >= 0) {
                                    this.drawBlock(x, y, this.currentPiece.color);
                                }
                            }
                        }
                    }
                }
            }

            drawBlock(x, y, color) {
                this.ctx.shadowBlur = 3;
                this.ctx.shadowColor = color;
                
                this.ctx.fillStyle = color;
                this.ctx.fillRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
                
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.fillRect(
                    x * this.blockSize + 2,
                    y * this.blockSize + 2,
                    this.blockSize - 4,
                    this.blockSize - 4
                );
                
                this.ctx.shadowBlur = 0;
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
            }

            drawEmptyBlock(x, y) {
                this.ctx.fillStyle = 'rgba(71, 85, 105, 0.1)';
                this.ctx.fillRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
                this.ctx.strokeStyle = 'rgba(71, 85, 105, 0.2)';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.blockSize,
                    y * this.blockSize,
                    this.blockSize,
                    this.blockSize
                );
            }

            getGhostPosition() {
                if (!this.currentPiece) {
                    return null;
                }

                const ghost = this.currentPiece.clone();
                while (!this.checkCollision(ghost, 0, 1)) {
                    ghost.position.y++;
                }
                return ghost;
            }

            drawNext() {
                this.nextCtx.fillStyle = '#1e293b';
                this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);

                if (!this.nextPieceType) {
                    return;
                }

                const nextPiece = new Tetromino(this.nextPieceType);
                const blockSize = 25;
                const shape = nextPiece.shape;
                
                const totalWidth = shape[0].length * blockSize;
                const totalHeight = shape.length * blockSize;
                const offsetX = (this.nextCanvas.width - totalWidth) / 2;
                const offsetY = (this.nextCanvas.height - totalHeight) / 2;

                for (let i = 0; i < shape.length; i++) {
                    for (let j = 0; j < shape[i].length; j++) {
                        if (shape[i][j] === 1) {
                            this.nextCtx.fillStyle = nextPiece.color;
                            this.nextCtx.fillRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                            this.nextCtx.strokeStyle = '#000';
                            this.nextCtx.lineWidth = 2;
                            this.nextCtx.strokeRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                        }
                    }
                }
            }

            showAction(text) {
                this.lastAction = text;
                const display = document.getElementById('actionDisplay');
                display.innerHTML = `<div class="action-text">${text}</div>`;

                setTimeout(() => {
                    display.innerHTML = '';
                }, 3000);
            }

            updateDisplay() {
                document.getElementById('scoreDisplay').textContent = this.score.toLocaleString();
                document.getElementById('levelDisplay').textContent = this.level;
                document.getElementById('linesDisplay').textContent = this.linesCleared;
            }

            // ===========================================
            // „Ç≤„Éº„É†Âà∂Âæ°
            // ===========================================
            togglePause() {
                if (this.isGameOver) {
                    return;
                }

                this.isPaused = !this.isPaused;
                const pauseOverlay = document.getElementById('pauseOverlay');
                const pauseButton = document.getElementById('pauseButton');

                if (this.isPaused) {
                    pauseOverlay.classList.remove('hidden');
                    pauseButton.textContent = '‚ñ∂ ÂÜçÈñã';
                    pauseOverlay.onclick = () => this.togglePause();
                } else {
                    pauseOverlay.classList.add('hidden');
                    pauseButton.textContent = '‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢';
                    pauseOverlay.onclick = null;
                }
            }

            goHome() {
                this.cleanup();
                
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('buttonControls').classList.add('hidden');
                document.getElementById('homeScreen').classList.remove('hidden');
                
                loadBestRecords();
                showRanking('normal');
            }

            reset() {
                this.cleanup();
                this.initializeGameState();
                
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('actionDisplay').innerHTML = '';
                document.getElementById('timeDisplay').textContent = '';
                
                this.init();
                this.updateDisplay();
                this.updateModeInfo();
            }

            cleanup() {
                this.stopTimer();
                
                if (this.animationFrameId !== null) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
            }
        }

        // ===========================================
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®Èñ¢Êï∞
        // ===========================================
        let game = null;
        let controlMode = 'swipe';
        
        function setupGlobalControls() {
            // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
            document.addEventListener('keydown', (e) => {
                if (!game || game.isGameOver) {
                    return;
                }

                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        game.moveLeft();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        game.moveRight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        game.rotate();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        if (!game.isPaused) {
                            game.moveDown(true);
                        }
                        break;
                    case ' ':
                        e.preventDefault();
                        game.hardDrop();
                        break;
                    case 'p':
                    case 'P':
                        e.preventDefault();
                        game.togglePause();
                        break;
                }
            });

            // „Çø„ÉÉ„ÉÅÊìç‰Ωú
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            const minSwipeDistance = 30;
            const tapMaxDuration = 200;

            const canvas = document.getElementById('gameCanvas');
            
            canvas.addEventListener('touchstart', (e) => {
                if (!game || game.isGameOver || game.isPaused) {
                    return;
                }
                
                e.preventDefault();
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
            });

            canvas.addEventListener('touchend', (e) => {
                if (!game || game.isGameOver || game.isPaused) {
                    return;
                }
                
                e.preventDefault();
                const touch = e.changedTouches[0];
                const touchEndX = touch.clientX;
                const touchEndY = touch.clientY;
                const touchDuration = Date.now() - touchStartTime;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);

                if (absDeltaX < minSwipeDistance && absDeltaY < minSwipeDistance && touchDuration < tapMaxDuration) {
                    game.rotate();
                    return;
                }

                if (absDeltaX > absDeltaY) {
                    if (deltaX < 0) {
                        game.moveLeft();
                    } else {
                        game.moveRight();
                    }
                } else {
                    if (deltaY < 0) {
                        game.hardDrop();
                    } else {
                        game.moveDown(true);
                    }
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });

            // UI„Éú„Çø„É≥
            document.getElementById('pauseButton').addEventListener('click', () => {
                if (game) {
                    game.togglePause();
                }
            });

            document.getElementById('restartButton').addEventListener('click', () => {
                if (game && confirm('„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    game.reset();
                }
            });

            document.getElementById('resetButton').addEventListener('click', () => {
                if (game && confirm('„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü')) {
                    game.goHome();
                }
            });

            document.getElementById('homeButton').addEventListener('click', () => {
                if (game) {
                    game.goHome();
                }
            });

            // „Éú„Çø„É≥Êìç‰ΩúÔºàtouchstart„ÅßÂç≥Â∫ß„Å´ÂèçÂøú„ÄÅclick„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            const gameButtons = [
                { id: 'leftBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveLeft() },
                { id: 'rightBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveRight() },
                { id: 'centerBtn', action: () => game && !game.isPaused && !game.isGameOver && game.moveDown(true) },
                { id: 'upBtn', action: () => game && !game.isPaused && !game.isGameOver && game.rotate() },
                { id: 'downBtn2', action: () => game && !game.isPaused && !game.isGameOver && game.hardDrop() }
            ];

            gameButtons.forEach(({ id, action }) => {
                const btn = document.getElementById(id);
                let touched = false;

                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    touched = true;
                    action();
                }, { passive: false });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                }, { passive: false });

                // „Éû„Ç¶„ÇπÁî®„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàPC„Åß„ÇÇÂãï‰ΩúÔºâ
                btn.addEventListener('click', (e) => {
                    if (!touched) {
                        action();
                    }
                    touched = false;
                });
            });
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            setupGlobalControls();
        });

        function toggleControlMode() {
            const isButton = document.getElementById('controlToggle').checked;
            const buttonControls = document.getElementById('buttonControls');
            const swipeInstructions = document.getElementById('swipeInstructions');
            
            if (isButton) {
                controlMode = 'button';
                buttonControls.classList.remove('hidden');
                swipeInstructions.classList.add('hidden');
            } else {
                controlMode = 'swipe';
                buttonControls.classList.add('hidden');
                swipeInstructions.classList.remove('hidden');
            }
        }

        function startGame(mode) {
            if (game) {
                game.cleanup();
                game = null;
            }
            
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('pauseOverlay').classList.add('hidden');
            
            const isButton = document.getElementById('controlToggle').checked;
            if (isButton) {
                document.getElementById('buttonControls').classList.remove('hidden');
            }
            
            game = new TetrisGame(mode);
        }

        function loadBestRecords() {
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            
            if (records.normal && records.normal.length > 0) {
                document.getElementById('normalBest').textContent = `ÊúÄÈ´ò: ${records.normal[0].score.toLocaleString()} ÁÇπ`;
            }
            
            if (records.sprint1m && records.sprint1m.length > 0) {
                document.getElementById('sprint1mBest').textContent = `ÊúÄÈ´ò: ${records.sprint1m[0].lines} „É©„Ç§„É≥`;
            }
            
            ['time10', 'time20', 'time50', 'time100'].forEach(mode => {
                if (records[mode] && records[mode].length > 0) {
                    const time = records[mode][0].time;
                    const totalSeconds = time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                    document.getElementById(`${mode}Best`).textContent = `Ë®òÈå≤: ${timeStr}`;
                }
            });
        }

        function showRanking(mode, event) {
            if (event && event.target) {
                document.querySelectorAll('.ranking-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            const rankingList = document.getElementById('rankingList');
            
            if (!records[mode] || records[mode].length === 0) {
                rankingList.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            rankingList.innerHTML = records[mode].map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
                
                let displayValue = '';
                if (mode === 'normal') {
                    displayValue = `${record.score.toLocaleString()} ÁÇπ`;
                } else if (mode === 'sprint1m') {
                    displayValue = `${record.lines} „É©„Ç§„É≥`;
                } else {
                    const totalSeconds = record.time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    displayValue = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                }
                
                return `
                    <div class="ranking-item">
                        <span class="rank">#${index + 1}</span>
                        <span class="time">${displayValue}</span>
                        <span class="date">${dateStr}</span>
                    </div>
                `;
            }).join('');
        }

        function createStarField() {
            const container = document.getElementById('starsBackground');
            const starCount = 100;
            const lineCount = 15;
            const shootingStarCount = 3;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.opacity = 0.3 + Math.random() * 0.5;
                container.appendChild(star);
            }

            const stars = container.querySelectorAll('.star');
            for (let i = 0; i < lineCount; i++) {
                const star1 = stars[Math.floor(Math.random() * stars.length)];
                const star2 = stars[Math.floor(Math.random() * stars.length)];
                
                if (star1 !== star2) {
                    const x1 = parseFloat(star1.style.left);
                    const y1 = parseFloat(star1.style.top);
                    const x2 = parseFloat(star2.style.left);
                    const y2 = parseFloat(star2.style.top);
                    
                    const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    
                    if (distance < 20) {
                        const line = document.createElement('div');
                        line.className = 'constellation-line';
                        line.style.left = x1 + '%';
                        line.style.top = y1 + '%';
                        line.style.width = distance + '%';
                        
                        const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                        line.style.transform = `rotate(${angle}deg)`;
                        
                        container.appendChild(line);
                    }
                }
            }

            for (let i = 0; i < shootingStarCount; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = Math.random() * 80 + '%';
                shootingStar.style.top = Math.random() * 50 + '%';
                shootingStar.style.animationDelay = Math.random() * 10 + 's';
                shootingStar.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(shootingStar);
            }
        }

        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÂÖ¨Èñã
        window.startGame = startGame;
        window.toggleControlMode = toggleControlMode;
        window.showRanking = showRanking;
        window.loadBestRecords = loadBestRecords;

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            loadBestRecords();
            showRanking('normal');
            createStarField();
        });
    </script>
</body>
</html>
