<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Å™„ÉÜ„Éà„É™„Çπ„Ç≤„Éº„É†">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>TETRIS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 40px;
            color: #00ffff;
            text-align: center;
            letter-spacing: 8px;
        }

        .action-display {
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-text {
            font-size: 20px;
            font-weight: bold;
            color: #ffff00;
            background-color: rgba(128, 0, 128, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .game-area {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        #gameCanvas {
            border: 3px solid #666;
            background-color: #000;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 200px;
        }

        .panel-section {
            background-color: rgba(128, 128, 128, 0.3);
            padding: 15px;
            border-radius: 8px;
        }

        .panel-section h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            text-align: center;
        }

        #nextCanvas {
            display: block;
            margin: 0 auto;
            background-color: rgba(128, 128, 128, 0.2);
            border-radius: 8px;
        }

        .score-display {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #fff;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
        }

        .level-value {
            color: #ffff00;
        }

        .controls-info {
            font-size: 10px;
            line-height: 1.6;
            color: #ccc;
        }

        .controls-info h4 {
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            text-align: center;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .button-group button {
            flex: 1;
        }

        /* Êìç‰ΩúÂàá„ÇäÊõø„Åà„Éà„Ç∞„É´ */
        #controlTogglePanel {
            padding: 10px;
        }

        #controlTogglePanel h3 {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #00ffff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-text {
            font-size: 12px;
            color: #aaa;
        }

        /* „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ */
        .button-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            font-size: 24px;
            background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
            border: 2px solid #00ffff;
            border-radius: 12px;
            color: #00ffff;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            line-height: 1.2;
        }

        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.5);
        }

        .control-btn:hover {
            background: linear-gradient(145deg, #3a3a4e, #2a2a3e);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }

        /* „Éç„Ç™„É≥ÂäπÊûú */
        .neon-glow {
            box-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 20px currentColor,
                inset 0 0 5px rgba(255, 255, 255, 0.2);
        }

        /* „É©„Ç§„É≥Ê∂àÂéª„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes lineFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        @keyframes lineClear {
            0% { 
                transform: scaleX(1);
                opacity: 1;
            }
            50% {
                transform: scaleX(1.1);
                opacity: 0.5;
            }
            100% { 
                transform: scaleX(0);
                opacity: 0;
            }
        }

        button {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .pause-button {
            background-color: #ffff00;
            color: #000;
        }

        .reset-button {
            background-color: #00ffff;
            color: #000;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .overlay-content {
            background-color: #000;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid;
        }

        .game-over-overlay {
            border-color: #ff0000;
        }

        .pause-overlay {
            border-color: #ffff00;
        }

        .overlay-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .game-over-title {
            color: #ff0000;
        }

        .pause-title {
            color: #ffff00;
        }

        .overlay-score {
            font-size: 20px;
            color: #fff;
            margin-bottom: 20px;
        }

        .overlay-button {
            background-color: #00ffff;
            color: #000;
            font-size: 18px;
            padding: 15px 30px;
        }

        .hidden {
            display: none;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .home-screen {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .home-title {
            font-size: 60px;
            color: #00ffff;
            letter-spacing: 12px;
            margin-bottom: 40px;
            text-shadow: 0 0 20px #00ffff;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .mode-button {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #00ffff;
            padding: 30px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-button:hover {
            transform: translateY(-5px);
            border-color: #ffff00;
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3);
        }

        .mode-button h2 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .mode-button p {
            color: #aaa;
            font-size: 14px;
            margin: 5px 0;
        }

        .mode-button .best-time {
            color: #ffff00;
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }

        .rankings {
            background: rgba(128, 128, 128, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .rankings h3 {
            color: #00ffff;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .ranking-tab {
            background: rgba(128, 128, 128, 0.3);
            color: #aaa;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .ranking-tab.active {
            background: #00ffff;
            color: #000;
            border-color: #00ffff;
        }

        .ranking-list {
            text-align: left;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 3px solid #00ffff;
        }

        .ranking-item .rank {
            color: #ffff00;
            font-weight: bold;
            min-width: 40px;
        }

        .ranking-item .time {
            color: #00ffff;
            font-weight: bold;
        }

        .ranking-item .date {
            color: #888;
            font-size: 12px;
        }

        /* „Çø„Ç§„É†Ë°®Á§∫ */
        .time-display {
            font-size: 18px;
            color: #ffff00;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .mode-info {
            font-size: 14px;
            color: #00ffff;
            text-align: center;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .home-title {
                font-size: 40px;
                letter-spacing: 8px;
                margin-bottom: 30px;
            }

            .mode-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .mode-button {
                padding: 20px 15px;
            }

            .mode-button h2 {
                font-size: 20px;
            }

            .ranking-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .ranking-tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }

            .game-container {
                gap: 10px;
                width: 100%;
                max-height: 100vh;
                padding-bottom: 180px; /* „Éú„Çø„É≥Êìç‰Ωú„Çπ„Éö„Éº„ÇπÁ¢∫‰øù */
            }

            h1 {
                font-size: 24px;
                letter-spacing: 4px;
                margin-top: 5px;
            }

            .action-display {
                min-height: 30px;
            }

            .action-text {
                font-size: 14px;
                padding: 6px 12px;
            }

            .game-area {
                flex-direction: row;
                align-items: flex-start;
                width: 100%;
                gap: 8px;
                justify-content: center;
            }

            #gameCanvas {
                flex-shrink: 0;
            }

            .side-panel {
                width: auto;
                min-width: 100px;
                gap: 8px;
                flex-shrink: 1;
            }

            .panel-section {
                padding: 8px;
            }

            .panel-section h3 {
                font-size: 10px;
                margin-bottom: 4px;
            }

            #nextCanvas {
                width: 80px;
                height: 80px;
            }

            .score-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .score-value {
                font-size: 16px;
            }

            .button-group {
                gap: 6px;
            }

            button {
                font-size: 11px;
                padding: 8px 6px;
            }

            .overlay-content {
                padding: 20px;
                margin: 10px;
            }

            .overlay-title {
                font-size: 28px;
            }

            .overlay-score {
                font-size: 16px;
            }

            .overlay-button {
                font-size: 16px;
                padding: 12px 24px;
            }

            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            #controlTogglePanel {
                padding: 6px;
            }

            #controlTogglePanel h3 {
                font-size: 10px;
            }

            .toggle-text {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
                letter-spacing: 2px;
            }

            .game-area {
                gap: 6px;
            }

            .side-panel {
                min-width: 90px;
                gap: 6px;
            }

            .panel-section {
                padding: 6px;
            }

            #nextCanvas {
                width: 70px;
                height: 70px;
            }

            .score-value {
                font-size: 14px;
            }

            button {
                font-size: 10px;
                padding: 6px 4px;
            }
        }

        @media (min-width: 769px) {
            .side-panel {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
    <div id="homeScreen" class="home-screen">
        <h1 class="home-title">TETRIS</h1>
        
        <div class="mode-selection">
            <div class="mode-button" onclick="startGame('normal')">
                <h2>„Éé„Éº„Éû„É´</h2>
                <p>„Ç®„É≥„Éâ„É¨„Çπ„É¢„Éº„Éâ</p>
                <p>„Çπ„Ç≥„Ç¢„Ç¢„Çø„ÉÉ„ÇØ</p>
                <div class="best-time" id="normalBest">ÊúÄÈ´ò: - ÁÇπ</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time10')">
                <h2>10„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>10„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time10Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time20')">
                <h2>20„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>20„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time20Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time50')">
                <h2>50„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>50„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time50Best">Ë®òÈå≤: --:--.---</div>
            </div>
            
            <div class="mode-button" onclick="startGame('time100')">
                <h2>100„É©„Ç§„É≥</h2>
                <p>„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</p>
                <p>100„É©„Ç§„É≥Ê∂àÂéª</p>
                <div class="best-time" id="time100Best">Ë®òÈå≤: --:--.---</div>
            </div>
        </div>

        <div class="rankings">
            <h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
            <div class="ranking-tabs">
                <button class="ranking-tab active" onclick="showRanking('normal')">„Éé„Éº„Éû„É´</button>
                <button class="ranking-tab" onclick="showRanking('time10')">10„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time20')">20„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time50')">50„É©„Ç§„É≥</button>
                <button class="ranking-tab" onclick="showRanking('time100')">100„É©„Ç§„É≥</button>
            </div>
            <div class="ranking-list" id="rankingList"></div>
        </div>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
    <div class="game-container hidden" id="gameScreen">
        <h1>TETRIS</h1>
        
        <div class="mode-info" id="modeInfo"></div>
        <div class="time-display" id="timeDisplay"></div>
        <div class="action-display" id="actionDisplay"></div>

        <div class="game-area">
            <canvas id="gameCanvas"></canvas>

            <div class="side-panel">
                <div class="panel-section">
                    <h3>NEXT</h3>
                    <canvas id="nextCanvas" width="100" height="100"></canvas>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É¨„Éô„É´</div>
                    <div class="score-value level-value" id="levelDisplay">1</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„Çπ„Ç≥„Ç¢</div>
                    <div class="score-value" id="scoreDisplay">0</div>
                </div>

                <div class="panel-section score-display">
                    <div class="score-label">„É©„Ç§„É≥</div>
                    <div class="score-value level-value" id="linesDisplay">0</div>
                </div>

                <div class="panel-section" id="controlTogglePanel">
                    <h3>Êìç‰ΩúÊñπÊ≥ï</h3>
                    <div class="toggle-container">
                        <label class="toggle-label">
                            <input type="checkbox" id="controlToggle" onchange="toggleControlMode()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-text">„Éú„Çø„É≥</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="pause-button" id="pauseButton">‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="reset-button" id="restartButton" style="display:none;">üîÑ „É™„Çπ„Çø„Éº„Éà</button>
                    <button class="reset-button" id="resetButton">üè† „Éõ„Éº„É†</button>
                </div>
            </div>
        </div>

        <!-- „Éú„Çø„É≥Êìç‰Ωú„Éë„Éç„É´ -->
        <div id="buttonControls" class="button-controls hidden">
            <div class="control-buttons">
                <button class="control-btn" id="rotateBtn">üîÑ<br>ÂõûËª¢</button>
                <button class="control-btn" id="dropBtn">‚¨áÔ∏è<br>ËêΩ‰∏ã</button>
            </div>
            <div class="control-buttons">
                <button class="control-btn" id="leftBtn">‚¨ÖÔ∏è</button>
                <button class="control-btn" id="downBtn">‚¨áÔ∏è</button>
                <button class="control-btn" id="rightBtn">‚û°Ô∏è</button>
            </div>
        </div>
    </div>

    <div id="gameOverOverlay" class="overlay hidden">
        <div class="overlay-content game-over-overlay">
            <div class="overlay-title game-over-title">GAME OVER</div>
            <div class="overlay-score">ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: <span id="finalScore">0</span></div>
            <button class="overlay-button" id="homeButton">üè† „Éõ„Éº„É†„Å´Êàª„Çã</button>
        </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
        <div class="overlay-content pause-overlay">
            <div class="overlay-title pause-title">‰∏ÄÊôÇÂÅúÊ≠¢</div>
            <div class="overlay-score">„Çø„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÈñã</div>
            <button class="overlay-button" onclick="game.togglePause()">‚ñ∂ ÂÜçÈñã</button>
        </div>
    </div>

    <script>
        const TETROMINO_TYPES = {
            I: {
                shape: [[1, 1, 1, 1]],
                color: '#00ffff'
            },
            O: {
                shape: [[1, 1], [1, 1]],
                color: '#ffff00'
            },
            T: {
                shape: [[0, 1, 0], [1, 1, 1]],
                color: '#800080'
            },
            S: {
                shape: [[0, 1, 1], [1, 1, 0]],
                color: '#00ff00'
            },
            Z: {
                shape: [[1, 1, 0], [0, 1, 1]],
                color: '#ff0000'
            },
            J: {
                shape: [[1, 0, 0], [1, 1, 1]],
                color: '#0000ff'
            },
            L: {
                shape: [[0, 0, 1], [1, 1, 1]],
                color: '#ff8800'
            }
        };

        class Tetromino {
            constructor(type) {
                this.type = type;
                this.shape = JSON.parse(JSON.stringify(TETROMINO_TYPES[type].shape));
                this.color = TETROMINO_TYPES[type].color;
                this.position = { x: 3, y: 0 };
            }

            rotate() {
                const newShape = [];
                const rows = this.shape.length;
                const cols = this.shape[0].length;

                for (let j = 0; j < cols; j++) {
                    const newRow = [];
                    for (let i = rows - 1; i >= 0; i--) {
                        newRow.push(this.shape[i][j]);
                    }
                    newShape.push(newRow);
                }

                const rotated = new Tetromino(this.type);
                rotated.shape = newShape;
                rotated.position = { ...this.position };
                return rotated;
            }

            clone() {
                const cloned = new Tetromino(this.type);
                cloned.shape = JSON.parse(JSON.stringify(this.shape));
                cloned.position = { ...this.position };
                return cloned;
            }
        }

        class TetrisGame {
            constructor(mode = 'normal') {
                this.mode = mode; // 'normal', 'time20', 'time50', 'time100'
                this.BOARD_WIDTH = 10;
                this.BOARD_HEIGHT = 20;
                
                // „Çπ„Éû„ÉõÂØæÂøú: ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶„Éñ„É≠„ÉÉ„ÇØ„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
                this.BLOCK_SIZE = this.calculateBlockSize();

                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = this.BOARD_WIDTH * this.BLOCK_SIZE;
                this.canvas.height = this.BOARD_HEIGHT * this.BLOCK_SIZE;

                this.nextCanvas = document.getElementById('nextCanvas');
                this.nextCtx = this.nextCanvas.getContext('2d');

                this.board = [];
                this.currentPiece = null;
                this.nextPieceType = null;
                this.score = 0;
                this.level = 1;
                this.totalLinesCleared = 0;
                this.linesRemoved = 0;
                this.isGameOver = false;
                this.isPaused = false;
                this.lastAction = '';
                this.lastMoveWasRotation = false;

                // „Çø„Ç§„É†Ê©üËÉΩ
                this.startTime = null;
                this.elapsedTime = 0;
                this.timerInterval = null;
                this.targetLines = this.getTargetLines();

                this.pieceBag = [];
                this.gameTimer = null;

                this.setupControls();
                this.init();
                this.updateModeInfo();
            }

            getTargetLines() {
                switch(this.mode) {
                    case 'time10': return 10;
                    case 'time20': return 20;
                    case 'time50': return 50;
                    case 'time100': return 100;
                    default: return null;
                }
            }

            updateModeInfo() {
                const modeInfo = document.getElementById('modeInfo');
                const restartButton = document.getElementById('restartButton');
                
                switch(this.mode) {
                    case 'normal':
                        modeInfo.textContent = 'üìä „Éé„Éº„Éû„É´„É¢„Éº„Éâ';
                        restartButton.style.display = 'none';
                        break;
                    case 'time10':
                        modeInfo.textContent = '‚è±Ô∏è 10„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ';
                        restartButton.style.display = 'block';
                        break;
                    case 'time20':
                        modeInfo.textContent = '‚è±Ô∏è 20„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ';
                        restartButton.style.display = 'block';
                        break;
                    case 'time50':
                        modeInfo.textContent = '‚è±Ô∏è 50„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ';
                        restartButton.style.display = 'block';
                        break;
                    case 'time100':
                        modeInfo.textContent = '‚è±Ô∏è 100„É©„Ç§„É≥ „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ';
                        restartButton.style.display = 'block';
                        break;
                }
            }

            startTimer() {
                // Êó¢„Å´„Çø„Ç§„Éû„Éº„ÅåÂãï„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                if (this.timerInterval) {
                    return;
                }
                
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused && !this.isGameOver) {
                        this.elapsedTime = Date.now() - this.startTime;
                        this.updateTimeDisplay();
                    }
                }, 10);
            }

            updateTimeDisplay() {
                const timeDisplay = document.getElementById('timeDisplay');
                
                const totalSeconds = this.elapsedTime / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds % 1) * 1000);
                
                if (this.mode === 'normal') {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    timeDisplay.textContent = `‚è±Ô∏è ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
                }
            }

            checkTimeAttackComplete() {
                if (this.targetLines && this.linesRemoved >= this.targetLines) {
                    this.isGameOver = true;
                    clearInterval(this.gameTimer);
                    clearInterval(this.timerInterval);
                    this.saveRecord();
                    this.showTimeAttackComplete();
                }
            }

            saveRecord() {
                const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
                if (!records[this.mode]) {
                    records[this.mode] = [];
                }

                const record = {
                    mode: this.mode,
                    time: this.elapsedTime,
                    score: this.score,
                    date: new Date().toISOString()
                };

                if (this.mode === 'normal') {
                    record.score = this.score;
                    delete record.time;
                }

                records[this.mode].push(record);
                records[this.mode].sort((a, b) => {
                    if (this.mode === 'normal') {
                        return b.score - a.score;
                    }
                    return a.time - b.time;
                });
                records[this.mode] = records[this.mode].slice(0, 10); // Top 10

                localStorage.setItem('tetrisRecords', JSON.stringify(records));
            }

            showTimeAttackComplete() {
                const totalSeconds = this.elapsedTime / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const milliseconds = Math.floor((totalSeconds % 1) * 1000);
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;

                document.getElementById('finalScore').textContent = `${timeStr}`;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
                
                // „Çø„Ç§„Éà„É´„ÇíÂ§âÊõ¥
                const title = document.querySelector('.game-over-title');
                title.textContent = 'COMPLETE!';
                title.style.color = '#00ff00';
            }

            formatTime(milliseconds) {
                const totalSeconds = milliseconds / 1000;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const ms = Math.floor((totalSeconds % 1) * 1000);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }

            calculateBlockSize() {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    // „Çπ„Éû„Éõ„Åß„ÅØ„Çµ„Ç§„Éâ„Éë„Éç„É´ÂàÜ„ÇíËÄÉÊÖÆ„Åó„Å¶„Éó„É¨„Ç§ÁîªÈù¢„ÇíÊúÄÂ§ßÂåñ
                    const availableWidth = window.innerWidth - 120; // „Çµ„Ç§„Éâ„Éë„Éç„É´ + „Éû„Éº„Ç∏„É≥
                    const blockSize = Math.floor(availableWidth / this.BOARD_WIDTH);
                    return Math.min(Math.max(blockSize, 20), 30); // 20-30px„ÅÆÁØÑÂõ≤
                }
                return 25;
            }

            init() {
                this.board = Array(this.BOARD_HEIGHT).fill(null).map(() => 
                    Array(this.BOARD_WIDTH).fill(null)
                );

                this.fillPieceBag();
                this.nextPieceType = this.getNextPiece();
                this.spawnNewPiece();
                this.startGameTimer();
                this.drawNext();
            }

            fillPieceBag() {
                const types = Object.keys(TETROMINO_TYPES);
                this.pieceBag = types.sort(() => Math.random() - 0.5);
            }

            getNextPiece() {
                if (this.pieceBag.length === 0) {
                    this.fillPieceBag();
                }
                return this.pieceBag.shift();
            }

            startGameTimer() {
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                }
                const speed = Math.max(200, 700 - (this.level - 1) * 50);
                this.gameTimer = setInterval(() => this.tick(), speed);
            }

            tick() {
                if (!this.isPaused && !this.isGameOver) {
                    this.moveDown();
                }
            }

            spawnNewPiece() {
                if (this.isGameOver) return;

                const newPiece = new Tetromino(this.nextPieceType);
                this.nextPieceType = this.getNextPiece();
                this.drawNext();

                if (this.checkCollision(newPiece, 0, 0)) {
                    this.isGameOver = true;
                    clearInterval(this.gameTimer);
                    clearInterval(this.timerInterval);
                    if (this.mode === 'normal') {
                        this.saveRecord();
                    }
                    this.showGameOver();
                } else {
                    this.currentPiece = newPiece;
                    // ÊúÄÂàù„ÅÆ„Éî„Éº„Çπ„ÅåÁîüÊàê„Åï„Çå„Åü„Çâ„Çø„Ç§„Éû„ÉºÈñãÂßãÔºà‰∫åÈáçËµ∑ÂãïÈò≤Ê≠¢Ê∏à„ÅøÔºâ
                    this.startTimer();
                }
            }

            checkCollision(piece, offsetX, offsetY) {
                for (let i = 0; i < piece.shape.length; i++) {
                    for (let j = 0; j < piece.shape[i].length; j++) {
                        if (piece.shape[i][j] === 1) {
                            const x = piece.position.x + j + offsetX;
                            const y = piece.position.y + i + offsetY;

                            // Â∑¶Âè≥„Å®‰∏ã„ÅÆÂ¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
                            if (x < 0 || x >= this.BOARD_WIDTH || y >= this.BOARD_HEIGHT) {
                                return true;
                            }

                            // ‰∏äÁ´ØÔºày < 0Ôºâ„ÅØ„Çπ„Éù„Éº„É≥ÊôÇ„ÅÆ„Åü„ÇÅË°ùÁ™ÅÂà§ÂÆö„Åó„Å™„ÅÑ
                            if (y >= 0 && y < this.BOARD_HEIGHT && x >= 0 && x < this.BOARD_WIDTH) {
                                // board„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                                if (this.board && this.board[y] && this.board[y][x] !== null) {
                                    return true;
                                }
                            }
                        }
                    }
                }
                return false;
            }

            moveDown(manual = false) {
                if (!this.currentPiece || this.isGameOver) return;

                if (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                    // ÊâãÂãï„Åß„ÅÆ‰∏ãÁßªÂãï„ÅÆ„ÅølastMoveWasRotation„Çí„É™„Çª„ÉÉ„Éà
                    if (manual) {
                        this.lastMoveWasRotation = false;
                    }
                } else {
                    this.lockPiece();
                }
                this.draw();
            }

            moveLeft() {
                if (!this.currentPiece || this.isPaused || this.isGameOver) return;

                if (!this.checkCollision(this.currentPiece, -1, 0)) {
                    this.currentPiece.position.x--;
                    this.lastMoveWasRotation = false;
                    this.draw();
                }
            }

            moveRight() {
                if (!this.currentPiece || this.isPaused || this.isGameOver) return;

                if (!this.checkCollision(this.currentPiece, 1, 0)) {
                    this.currentPiece.position.x++;
                    this.lastMoveWasRotation = false;
                    this.draw();
                }
            }

            rotate() {
                if (!this.currentPiece || this.isPaused || this.isGameOver) return;

                const rotated = this.currentPiece.rotate();
                
                if (!this.checkCollision(rotated, 0, 0)) {
                    this.currentPiece = rotated;
                    this.lastMoveWasRotation = true;
                    this.draw();
                    return;
                }

                // Super Rotation System (SRS) - Â£Å„Ç≠„ÉÉ„ÇØ
                const kickTests = [
                    [-1, 0], [1, 0], [0, -1], [-1, -1], [1, -1]
                ];

                for (const [kickX, kickY] of kickTests) {
                    const kicked = rotated.clone();
                    kicked.position.x += kickX;
                    kicked.position.y += kickY;

                    if (!this.checkCollision(kicked, 0, 0)) {
                        this.currentPiece = kicked;
                        this.lastMoveWasRotation = true;
                        this.draw();
                        return;
                    }
                }
            }

            hardDrop() {
                if (!this.currentPiece || this.isPaused || this.isGameOver) return;

                while (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.position.y++;
                }
                this.lastMoveWasRotation = false;
                this.lockPiece();
                this.draw();
            }

            lockPiece() {
                if (!this.currentPiece) return;

                const isTSpin = this.checkTSpin(this.currentPiece);

                // „Éú„Éº„Éâ„Å´„Éî„Éº„Çπ„ÇíÂõ∫ÂÆö
                for (let i = 0; i < this.currentPiece.shape.length; i++) {
                    for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                        if (this.currentPiece.shape[i][j] === 1) {
                            const x = this.currentPiece.position.x + j;
                            const y = this.currentPiece.position.y + i;
                            if (y >= 0 && y < this.BOARD_HEIGHT && x >= 0 && x < this.BOARD_WIDTH) {
                                this.board[y][x] = this.currentPiece.color;
                            }
                        }
                    }
                }

                const linesCleared = this.clearLines();

                // T„Çπ„Éî„É≥„Éú„Éº„Éä„Çπ
                if (isTSpin && linesCleared > 0) {
                    const bonus = linesCleared * 400 * this.level;
                    this.score += bonus;
                    const spinType = linesCleared === 1 ? 'SINGLE' : linesCleared === 2 ? 'DOUBLE' : 'TRIPLE';
                    this.showAction(`T-SPIN ${spinType}! +${bonus}`);
                } else if (linesCleared === 4) {
                    // „ÉÜ„Éà„É™„ÇπÔºà4„É©„Ç§„É≥ÂêåÊôÇÊ∂à„ÅóÔºâ„Éú„Éº„Éä„Çπ
                    const bonus = 800 * this.level;
                    this.score += bonus;
                    this.showAction(`TETRIS! +${bonus}`);
                }

                this.updateDisplay();
                this.lastMoveWasRotation = false;
                
                // Êñ∞„Åó„ÅÑ„Éî„Éº„Çπ„ÇíÁîüÊàê
                this.spawnNewPiece();
            }

            checkTSpin(piece) {
                if (piece.type !== 'T' || !this.lastMoveWasRotation) {
                    return false;
                }

                const x = piece.position.x;
                const y = piece.position.y;

                // TÂ≠ó„Éñ„É≠„ÉÉ„ÇØ„ÅÆ4„Å§„ÅÆËßí„ÅÆÂ∫ßÊ®ôÔºà3x3„Ç∞„É™„ÉÉ„ÉâÂü∫Ê∫ñÔºâ
                const corners = [
                    [x, y],
                    [x + 2, y],
                    [x, y + 2],
                    [x + 2, y + 2]
                ];

                let filledCorners = 0;
                for (const [cx, cy] of corners) {
                    if (cx < 0 || cx >= this.BOARD_WIDTH || cy < 0 || cy >= this.BOARD_HEIGHT) {
                        filledCorners++;
                    } else if (cy >= 0 && cy < this.BOARD_HEIGHT && cx >= 0 && cx < this.BOARD_WIDTH && this.board[cy][cx] !== null) {
                        filledCorners++;
                    }
                }

                return filledCorners >= 3;
            }

            clearLines() {
                let linesCleared = 0;
                const linesToClear = [];

                // „ÇØ„É™„Ç¢„Åô„Çã„É©„Ç§„É≥„ÇíÁâπÂÆö
                for (let y = 0; y < this.board.length; y++) {
                    if (this.board[y].every(cell => cell !== null)) {
                        linesToClear.push(y);
                        linesCleared++;
                    }
                }

                if (linesCleared > 0) {
                    // „Ç®„Éï„Çß„ÇØ„Éà: „É©„Ç§„É≥„ÇíÁôΩ„ÅèÂÖâ„Çâ„Åõ„Çã
                    this.flashLines(linesToClear);
                    
                    // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É©„Ç§„É≥„ÇíÊ∂àÂéª
                    setTimeout(() => {
                        const newBoard = [];
                        for (let y = 0; y < this.board.length; y++) {
                            if (!linesToClear.includes(y)) {
                                newBoard.push(this.board[y]);
                            }
                        }

                        while (newBoard.length < this.BOARD_HEIGHT) {
                            newBoard.unshift(Array(this.BOARD_WIDTH).fill(null));
                        }

                        this.board = newBoard;

                        // „Çπ„Ç≥„Ç¢Ë®àÁÆó
                        let lineScore = 25;
                        if (linesCleared === 2) lineScore = 100;
                        else if (linesCleared === 3) lineScore = 400;
                        else if (linesCleared === 4) lineScore = 1600;

                        this.score += lineScore * (this.level + 1);
                        this.linesRemoved += linesCleared;

                        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„É≠„Ç∏„ÉÉ„ÇØ
                        this.totalLinesCleared += linesCleared;
                        const newLevel = Math.floor(this.linesRemoved / 10) + 1;

                        if (newLevel > this.level) {
                            this.level = newLevel;
                            this.startGameTimer();
                        }

                        // „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                        this.checkTimeAttackComplete();
                        
                        this.draw();
                    }, 200);
                }

                return linesCleared;
            }

            flashLines(lines) {
                // ÂÖâ„Çã„Ç®„Éï„Çß„ÇØ„Éà
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        for (const y of lines) {
                            for (let x = 0; x < this.BOARD_WIDTH; x++) {
                                if (i % 2 === 0) {
                                    this.ctx.fillStyle = '#ffffff';
                                } else {
                                    this.ctx.fillStyle = this.board[y][x] || '#ffffff';
                                }
                                this.ctx.fillRect(
                                    x * this.BLOCK_SIZE,
                                    y * this.BLOCK_SIZE,
                                    this.BLOCK_SIZE,
                                    this.BLOCK_SIZE
                                );
                            }
                        }
                    }, i * 60);
                }
            }

            showAction(text) {
                this.lastAction = text;
                const display = document.getElementById('actionDisplay');
                display.innerHTML = `<div class="action-text">${text}</div>`;

                setTimeout(() => {
                    display.innerHTML = '';
                }, 3000);
            }

            updateDisplay() {
                document.getElementById('scoreDisplay').textContent = this.score.toLocaleString();
                document.getElementById('levelDisplay').textContent = this.level;
                document.getElementById('linesDisplay').textContent = this.linesRemoved;
            }

            getGhostPosition() {
                if (!this.currentPiece) return null;

                const ghost = this.currentPiece.clone();
                while (!this.checkCollision(ghost, 0, 1)) {
                    ghost.position.y++;
                }
                return ghost;
            }

            draw() {
                // „Éú„Éº„Éâ„Çí„ÇØ„É™„Ç¢
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // „Éú„Éº„Éâ‰∏ä„ÅÆÂõ∫ÂÆö„Åï„Çå„Åü„Éñ„É≠„ÉÉ„ÇØ„ÇíÊèèÁîª
                for (let y = 0; y < this.BOARD_HEIGHT; y++) {
                    for (let x = 0; x < this.BOARD_WIDTH; x++) {
                        if (this.board[y][x]) {
                            this.drawBlock(x, y, this.board[y][x]);
                        } else {
                            this.drawEmptyBlock(x, y);
                        }
                    }
                }

                // „Ç¥„Éº„Çπ„ÉàÔºàÂΩ±Ôºâ„ÇíÊèèÁîª
                if (this.currentPiece) {
                    const ghost = this.getGhostPosition();
                    if (ghost) {
                        for (let i = 0; i < ghost.shape.length; i++) {
                            for (let j = 0; j < ghost.shape[i].length; j++) {
                                if (ghost.shape[i][j] === 1) {
                                    const x = ghost.position.x + j;
                                    const y = ghost.position.y + i;
                                    if (y >= 0) {
                                        // „Ç¥„Éº„Çπ„Éà„ÅØÁÇπÁ∑ö„ÅÆÊû†„ÅÆ„Åø
                                        this.ctx.strokeStyle = this.currentPiece.color;
                                        this.ctx.lineWidth = 2;
                                        this.ctx.setLineDash([5, 5]);
                                        this.ctx.strokeRect(
                                            x * this.BLOCK_SIZE,
                                            y * this.BLOCK_SIZE,
                                            this.BLOCK_SIZE,
                                            this.BLOCK_SIZE
                                        );
                                        this.ctx.setLineDash([]);
                                    }
                                }
                            }
                        }
                    }

                    // ÁèæÂú®„ÅÆ„Éî„Éº„Çπ„ÇíÊèèÁîªÔºà„Éç„Ç™„É≥ÂäπÊûú‰ªò„ÅçÔºâ
                    for (let i = 0; i < this.currentPiece.shape.length; i++) {
                        for (let j = 0; j < this.currentPiece.shape[i].length; j++) {
                            if (this.currentPiece.shape[i][j] === 1) {
                                const x = this.currentPiece.position.x + j;
                                const y = this.currentPiece.position.y + i;
                                if (y >= 0) {
                                    this.drawBlock(x, y, this.currentPiece.color);
                                }
                            }
                        }
                    }
                }
            }

            drawBlock(x, y, color) {
                // „Éç„Ç™„É≥ÂäπÊûú„ÅÆ„Åü„ÇÅ„ÅÆ„Ç∞„É≠„Éº
                this.ctx.shadowBlur = 10;
                this.ctx.shadowColor = color;
                
                this.ctx.fillStyle = color;
                this.ctx.fillRect(
                    x * this.BLOCK_SIZE,
                    y * this.BLOCK_SIZE,
                    this.BLOCK_SIZE,
                    this.BLOCK_SIZE
                );
                
                // „Ç§„É≥„Éä„Éº„Éè„Ç§„É©„Ç§„Éà
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                this.ctx.fillRect(
                    x * this.BLOCK_SIZE + 2,
                    y * this.BLOCK_SIZE + 2,
                    this.BLOCK_SIZE - 4,
                    this.BLOCK_SIZE - 4
                );
                
                this.ctx.shadowBlur = 0;
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.BLOCK_SIZE,
                    y * this.BLOCK_SIZE,
                    this.BLOCK_SIZE,
                    this.BLOCK_SIZE
                );
            }

            drawEmptyBlock(x, y) {
                this.ctx.fillStyle = 'rgba(128, 128, 128, 0.2)';
                this.ctx.fillRect(
                    x * this.BLOCK_SIZE,
                    y * this.BLOCK_SIZE,
                    this.BLOCK_SIZE,
                    this.BLOCK_SIZE
                );
                this.ctx.strokeStyle = '#000';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(
                    x * this.BLOCK_SIZE,
                    y * this.BLOCK_SIZE,
                    this.BLOCK_SIZE,
                    this.BLOCK_SIZE
                );
            }

            drawNext() {
                // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
                this.nextCtx.fillStyle = '#000';
                this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);

                if (!this.nextPieceType) return;

                const nextPiece = new Tetromino(this.nextPieceType);
                const blockSize = 18;
                const shape = nextPiece.shape;
                
                const totalWidth = shape[0].length * blockSize;
                const totalHeight = shape.length * blockSize;
                const offsetX = (this.nextCanvas.width - totalWidth) / 2;
                const offsetY = (this.nextCanvas.height - totalHeight) / 2;

                for (let i = 0; i < shape.length; i++) {
                    for (let j = 0; j < shape[i].length; j++) {
                        if (shape[i][j] === 1) {
                            this.nextCtx.fillStyle = nextPiece.color;
                            this.nextCtx.fillRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                            this.nextCtx.strokeStyle = '#000';
                            this.nextCtx.lineWidth = 2;
                            this.nextCtx.strokeRect(
                                offsetX + j * blockSize,
                                offsetY + i * blockSize,
                                blockSize,
                                blockSize
                            );
                        }
                    }
                }
            }

            togglePause() {
                if (this.isGameOver) return;

                this.isPaused = !this.isPaused;
                const pauseOverlay = document.getElementById('pauseOverlay');
                const pauseButton = document.getElementById('pauseButton');

                if (this.isPaused) {
                    pauseOverlay.classList.remove('hidden');
                    pauseButton.textContent = '‚ñ∂ ÂÜçÈñã';
                    // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜçÈñã
                    pauseOverlay.onclick = () => this.togglePause();
                } else {
                    pauseOverlay.classList.add('hidden');
                    pauseButton.textContent = '‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢';
                    pauseOverlay.onclick = null;
                }
            }

            showGameOver() {
                document.getElementById('finalScore').textContent = this.score.toLocaleString();
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }

            reset() {
                clearInterval(this.gameTimer);
                
                this.score = 0;
                this.level = 1;
                this.totalLinesCleared = 0;
                this.linesRemoved = 0;
                this.isGameOver = false;
                this.isPaused = false;
                this.lastAction = '';
                this.pieceBag = [];

                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('actionDisplay').innerHTML = '';
                document.getElementById('pauseButton').textContent = '‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢';

                this.init();
                this.updateDisplay();
                this.draw();
            }

            setupControls() {
                // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
                document.addEventListener('keydown', (e) => {
                    if (this.isGameOver) return;

                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.moveLeft();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.moveRight();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            this.rotate();
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            if (!this.isPaused) {
                                this.moveDown(true); // ÊâãÂãïÊìç‰Ωú
                            }
                            break;
                        case ' ':
                            e.preventDefault();
                            this.hardDrop();
                            break;
                        case 'p':
                        case 'P':
                            e.preventDefault();
                            this.togglePause();
                            break;
                    }
                });

                // „Çø„ÉÉ„ÉÅÊìç‰Ωú
                let touchStartX = 0;
                let touchStartY = 0;
                let touchStartTime = 0;
                const minSwipeDistance = 30;
                const tapMaxDuration = 200;

                this.canvas.addEventListener('touchstart', (e) => {
                    if (this.isGameOver || this.isPaused) return;
                    
                    e.preventDefault();
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    touchStartTime = Date.now();
                });

                this.canvas.addEventListener('touchend', (e) => {
                    if (this.isGameOver || this.isPaused) return;
                    
                    e.preventDefault();
                    const touch = e.changedTouches[0];
                    const touchEndX = touch.clientX;
                    const touchEndY = touch.clientY;
                    const touchDuration = Date.now() - touchStartTime;

                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    const absDeltaX = Math.abs(deltaX);
                    const absDeltaY = Math.abs(deltaY);

                    // „Çø„ÉÉ„ÉóÂà§ÂÆöÔºàÂõûËª¢Ôºâ
                    if (absDeltaX < minSwipeDistance && absDeltaY < minSwipeDistance && touchDuration < tapMaxDuration) {
                        this.rotate();
                        return;
                    }

                    // „Çπ„ÉØ„Ç§„ÉóÂà§ÂÆö
                    if (absDeltaX > absDeltaY) {
                        // Ê®™ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó
                        if (deltaX < 0) {
                            this.moveLeft();
                        } else {
                            this.moveRight();
                        }
                    } else {
                        // Á∏¶ÊñπÂêë„ÅÆ„Çπ„ÉØ„Ç§„Éó
                        if (deltaY < 0) {
                            // ‰∏ä„Çπ„ÉØ„Ç§„Éó - „Éè„Éº„Éâ„Éâ„É≠„ÉÉ„Éó
                            this.hardDrop();
                        } else {
                            // ‰∏ã„Çπ„ÉØ„Ç§„Éó - È´òÈÄüËêΩ‰∏ãÔºàÊâãÂãïÔºâ
                            this.moveDown(true);
                        }
                    }
                });

                // „Çø„ÉÉ„ÉÅÁßªÂãï‰∏≠„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤Ê≠¢
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });

                document.getElementById('pauseButton').addEventListener('click', () => {
                    this.togglePause();
                });

                document.getElementById('restartButton').addEventListener('click', () => {
                    if (confirm('„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                        this.reset();
                    }
                });

                document.getElementById('resetButton').addEventListener('click', () => {
                    if (confirm('„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü')) {
                        this.goHome();
                    }
                });

                // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„ÅÆ„Éõ„Éº„É†„Éú„Çø„É≥
                document.getElementById('homeButton').addEventListener('click', () => {
                    this.goHome();
                });

                // „Éú„Çø„É≥Êìç‰Ωú„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                document.getElementById('leftBtn').addEventListener('click', () => {
                    if (!this.isPaused && !this.isGameOver) this.moveLeft();
                });

                document.getElementById('rightBtn').addEventListener('click', () => {
                    if (!this.isPaused && !this.isGameOver) this.moveRight();
                });

                document.getElementById('downBtn').addEventListener('click', () => {
                    if (!this.isPaused && !this.isGameOver) this.moveDown(true);
                });

                document.getElementById('rotateBtn').addEventListener('click', () => {
                    if (!this.isPaused && !this.isGameOver) this.rotate();
                });

                document.getElementById('dropBtn').addEventListener('click', () => {
                    if (!this.isPaused && !this.isGameOver) this.hardDrop();
                });
            }

            goHome() {
                clearInterval(this.gameTimer);
                clearInterval(this.timerInterval);
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('buttonControls').classList.add('hidden');
                document.getElementById('homeScreen').classList.remove('hidden');
                loadBestRecords();
                showRanking('normal');
            }

            reset() {
                // „Çø„Ç§„Éû„Éº„ÇíÂÆåÂÖ®„Å´ÂÅúÊ≠¢
                clearInterval(this.gameTimer);
                clearInterval(this.timerInterval);
                this.gameTimer = null;
                this.timerInterval = null;
                
                // Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                this.board = [];
                this.currentPiece = null;
                this.nextPieceType = null;
                this.score = 0;
                this.level = 1;
                this.totalLinesCleared = 0;
                this.linesRemoved = 0;
                this.isGameOver = false;
                this.isPaused = false;
                this.lastAction = '';
                this.lastMoveWasRotation = false;
                
                // „Çø„Ç§„Éû„Éº„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà
                this.startTime = null;
                this.elapsedTime = 0;
                
                this.pieceBag = [];
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈö†„Åô
                document.getElementById('gameOverOverlay').classList.add('hidden');
                document.getElementById('pauseOverlay').classList.add('hidden');
                document.getElementById('actionDisplay').innerHTML = '';
                document.getElementById('timeDisplay').textContent = '';
                
                // „Ç≤„Éº„É†„ÇíÂÜçÂàùÊúüÂåñ
                this.init();
                this.updateDisplay();
                this.updateModeInfo();
                this.draw();
            }

            showGameOver() {
                const title = document.querySelector('.game-over-title');
                title.textContent = 'GAME OVER';
                title.style.color = '#ff0000';
                
                if (this.mode === 'normal') {
                    document.getElementById('finalScore').textContent = this.score.toLocaleString() + ' ÁÇπ';
                }
                document.getElementById('gameOverOverlay').classList.remove('hidden');
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        let game = null;
        let controlMode = 'swipe'; // 'swipe' or 'button'

        function toggleControlMode() {
            const isButton = document.getElementById('controlToggle').checked;
            const buttonControls = document.getElementById('buttonControls');
            
            if (isButton) {
                controlMode = 'button';
                buttonControls.classList.remove('hidden');
            } else {
                controlMode = 'swipe';
                buttonControls.classList.add('hidden');
            }
        }

        function startGame(mode) {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('pauseOverlay').classList.add('hidden');
            
            // „Éú„Çø„É≥Êìç‰Ωú„ÅÆÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
            const isButton = document.getElementById('controlToggle').checked;
            if (isButton) {
                document.getElementById('buttonControls').classList.remove('hidden');
            }
            
            game = new TetrisGame(mode);
        }

        function loadBestRecords() {
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            
            // „Éé„Éº„Éû„É´„É¢„Éº„Éâ
            if (records.normal && records.normal.length > 0) {
                document.getElementById('normalBest').textContent = `ÊúÄÈ´ò: ${records.normal[0].score.toLocaleString()} ÁÇπ`;
            }
            
            // „Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ
            ['time10', 'time20', 'time50', 'time100'].forEach(mode => {
                if (records[mode] && records[mode].length > 0) {
                    const time = records[mode][0].time;
                    const totalSeconds = time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                    document.getElementById(`${mode}Best`).textContent = `Ë®òÈå≤: ${timeStr}`;
                }
            });
        }

        function showRanking(mode) {
            // „Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.ranking-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const records = JSON.parse(localStorage.getItem('tetrisRecords') || '{}');
            const rankingList = document.getElementById('rankingList');
            
            if (!records[mode] || records[mode].length === 0) {
                rankingList.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }
            
            rankingList.innerHTML = records[mode].map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
                
                let displayValue = '';
                if (mode === 'normal') {
                    displayValue = `${record.score.toLocaleString()} ÁÇπ`;
                } else {
                    const totalSeconds = record.time / 1000;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = Math.floor(totalSeconds % 60);
                    const ms = Math.floor((totalSeconds % 1) * 1000);
                    displayValue = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
                }
                
                return `
                    <div class="ranking-item">
                        <span class="rank">#${index + 1}</span>
                        <span class="time">${displayValue}</span>
                        <span class="date">${dateStr}</span>
                    </div>
                `;
            }).join('');
        }

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            loadBestRecords();
            showRanking('normal');
        });

        // Service WorkerÁôªÈå≤
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
